

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/imgfavicon.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>Nowcoder Community Code Review - Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/ocean.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Main</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/imgdefault.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Nowcoder Community Code Review">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-12-14 16:52" pubdate>
        2020年12月14日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      20.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      338
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Nowcoder Community Code Review</h1>
            
            <div class="markdown-body">
              <iframe frameborder="no" border="0" marginwidth="0" position="fixed"  marginheight="0" left=0 width=330 height=86 src="//music.163.com/outchain/player?type=2&id=347572&auto=1&height=66"></iframe>

<h1 id="系统分析"><a href="#系统分析" class="headerlink" title="系统分析"></a>系统分析</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201216143154.png" srcset="/img/loading.gif" alt="需求列表"></p>
<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201216150139.png" srcset="/img/loading.gif" alt="数据库表设计1"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201216150203.png" srcset="/img/loading.gif" alt="数据库表设计2"></p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><ul>
<li><p>技术栈架构</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201216151114.png" srcset="/img/loading.gif" alt="技术栈"></p>
</li>
<li><p>部署架构</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219154749.png" srcset="/img/loading.gif" alt="部署架构图"></p>
</li>
</ul>
<h2 id="项目结构一览"><a href="#项目结构一览" class="headerlink" title="项目结构一览"></a>项目结构一览</h2><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219160159.png" srcset="/img/loading.gif" alt="结构"></p>
<p>此结构有瑕疵，application配置文件应区分 <strong>dev or produce</strong></p>
<h2 id="项目开发前框架基础配置"><a href="#项目开发前框架基础配置" class="headerlink" title="项目开发前框架基础配置"></a>项目开发前框架基础配置</h2><blockquote>
<p>Mybatis</p>
</blockquote>
<div class="hljs"><pre><code class="hljs xml"># MybatisProperties
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.nowcoder.community.entity
mybatis.configuration.useGeneratedKeys=true
#驼峰命名与数据库下划线命名转换
mybatis.configuration.mapUnderscoreToCamelCase=true</code></pre></div>



<blockquote>
<p>Spring</p>
</blockquote>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-comment"># ServerProperties</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/community</span>

<span class="hljs-comment"># ThymeleafProperties</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">thymeleaf:</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment"># DataSourceProperties</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/community?characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Hongkong</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">15</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span></code></pre></div>

<p>默认使用 <strong>hikari连接池</strong></p>
<blockquote>
<p>maven</p>
</blockquote>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
  	<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre></div>



<h1 id="首页展示模块"><a href="#首页展示模块" class="headerlink" title="首页展示模块"></a>首页展示模块</h1><h2 id="开发社区首页"><a href="#开发社区首页" class="headerlink" title="开发社区首页"></a>开发社区首页</h2><h3 id="开发流程概括"><a href="#开发流程概括" class="headerlink" title="开发流程概括"></a>开发流程概括</h3><ul>
<li><p>流程请求执行过程</p>
<ul>
<li><p>1次请求的执行过程</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219155543.png" srcset="/img/loading.gif" alt="请求过程"></p>
</li>
</ul>
</li>
<li><p>分步实现</p>
<ul>
<li>开发首页，显示前十个帖子</li>
<li>开发 <strong>分页</strong> 组件(手动实现)，分页显示所有帖子</li>
</ul>
</li>
</ul>
<p>基础配置已在系统分析给出，不再多概述。</p>
<blockquote>
<p>编写分页前，只显示十条数据</p>
</blockquote>
<ol>
<li><p>编写 <strong>实体类</strong></p>
<p>为什么要同时编写 User相关的，因为页面需要Username，headerUrl等信息，所以查询一并返回。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-comment">// 使用了lombok</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscussPost</span> </span>&#123;
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> userId;
    <span class="hljs-keyword">private</span> String title;
    <span class="hljs-keyword">private</span> String content;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> type;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> status;
    <span class="hljs-keyword">private</span> Date createTime;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> commentCount;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> score;

&#125;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> String salt;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> type;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> status;
    <span class="hljs-keyword">private</span> String activationCode;
    <span class="hljs-keyword">private</span> String headerUrl;
    <span class="hljs-keyword">private</span> Date createTime;
&#125;</code></pre></div>
</li>
<li><p>描述接口Mapper</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DiscussPostMapper</span> </span>&#123;

    <span class="hljs-comment">// userId为&quot;我发布的帖子&quot;功能调用</span>
    <span class="hljs-comment">// offset,limit为分页功能调用</span>
    <span class="hljs-function">List&lt;DiscussPost&gt; <span class="hljs-title">selectDiscussPosts</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit, <span class="hljs-keyword">int</span> orderMode)</span></span>;
		<span class="hljs-comment">// @Param注解用于给参数取别名</span>
    <span class="hljs-comment">// 动态sql在&lt;if&gt;中使用,单一参数,一定要取别名,否则报错</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectDiscussPostRows</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;userId&quot;)</span> <span class="hljs-keyword">int</span> userId)</span></span>;
&#125;

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>&#123;

    <span class="hljs-function">User <span class="hljs-title">selectById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;
&#125;</code></pre></div>
</li>
<li><p>写接口对应的Mapper文件</p>
<p>xml文件开头过于冗余，已忽略，请查略源代码文件</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- discussPost-mapper --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span>
    id, user_id, title, content, type, status, create_time, comment_count, score
<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDiscussPosts&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;DiscussPost&quot;</span>&gt;</span>
        select
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
        from discuss_post
        where status != 2
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId!=0&quot;</span>&gt;</span>
            and user_id = #&#123;userId&#125;
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        limit #&#123;offset&#125;,#&#123;limit&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDiscussPostRows&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span>
        select count(id)
        from discuss_post
        where status != 2
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId!=0&quot;</span>&gt;</span>
            and user_id = #&#123;userId&#125;
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-comment">&lt;!-- user-mapper --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span>
        id, username, password, salt, email, type, status, activation_code, header_url, create_time
<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span>
        select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
        from user
        where id = #&#123;id&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></code></pre></div>
</li>
<li><p>写Service</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscussPostService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscussPostMapper discussPostMapper;

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;DiscussPost&gt; <span class="hljs-title">findDiscussPosts</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span> </span>&#123;
        <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPosts(userId, offset, limit);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findDiscussPostRows</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span> </span>&#123;
        <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPostRows(userId);
    &#125;
&#125;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;

    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findUserById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;
        <span class="hljs-keyword">return</span> userMapper.selectById(id);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写HomeController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscussPostService discussPostService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getIndexPage</span><span class="hljs-params">(Model model)</span> </span>&#123;

        List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(<span class="hljs-number">0</span>, page.getOffset(), page.getLimit());
        List&lt;Map&lt;String, Object&gt;&gt; discussPosts = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">if</span> (list != <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-keyword">for</span> (DiscussPost post : list) &#123;
                Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
                map.put(<span class="hljs-string">&quot;post&quot;</span>, post);
                User user = userService.findUserById(post.getUserId());
                map.put(<span class="hljs-string">&quot;user&quot;</span>, user);
                discussPosts.add(map);
            &#125;
        &#125;
        model.addAttribute(<span class="hljs-string">&quot;discussPosts&quot;</span>, discussPosts);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/index&quot;</span>;
    &#125;

&#125;</code></pre></div>
</li>
<li><p>对index页进行 <strong>模版引擎修改</strong> </p>
<p>详细修改请查看源代码</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219164449.png" srcset="/img/loading.gif" alt="index修改"></p>
</li>
<li><p>总体流程归纳：</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219164943.png" srcset="/img/loading.gif" alt="流程归纳"></p>
</li>
</ol>
<blockquote>
<p>编写分页</p>
</blockquote>
<ol>
<li><p>封装分页对象</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 封装分页相关信息</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span> </span>&#123;

    <span class="hljs-comment">// 当前页码(默认为1)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> current = <span class="hljs-number">1</span>;
    <span class="hljs-comment">// 显示上限(默认为10)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> limit = <span class="hljs-number">10</span>;
    <span class="hljs-comment">// 数据总数,用于计算总的页数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> rows;
    <span class="hljs-comment">// 查询路径,用于复用分页链接</span>
    <span class="hljs-keyword">private</span> String path;
&#125;</code></pre></div>

<p>分页里面的set和get方法有 <strong>技巧</strong>，有许多判断和默认值，不使用lombok，详细代码请看源码。</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219165225.png" srcset="/img/loading.gif" alt="分页对象信息"></p>
</li>
<li><p>修改HomeController</p>
<p>修改后的controller：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getIndexPage</span><span class="hljs-params">(Model model, Page page)</span> </span>&#123;
    <span class="hljs-comment">// 方法调用前,SpringMVC会自动实例化Model和Page,并将Page注入Model.</span>
    <span class="hljs-comment">// 所以,在thymeleaf中可以直接访问Page对象中的数据.</span>
    page.setRows(discussPostService.findDiscussPostRows(<span class="hljs-number">0</span>));
    page.setPath(<span class="hljs-string">&quot;/index&quot;</span>);

    List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(<span class="hljs-number">0</span>, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String, Object&gt;&gt; discussPosts = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">if</span> (list != <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">for</span> (DiscussPost post : list) &#123;
            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
            map.put(<span class="hljs-string">&quot;post&quot;</span>, post);
            User user = userService.findUserById(post.getUserId());
            map.put(<span class="hljs-string">&quot;user&quot;</span>, user);
            discussPosts.add(map);
        &#125;
    &#125;
    model.addAttribute(<span class="hljs-string">&quot;discussPosts&quot;</span>, discussPosts);
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/index&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎分页系统(可复用)</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219165634.png" srcset="/img/loading.gif" alt="模版引擎处理"></p>
</li>
<li><p>分页总体流程归纳</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219170954.png" srcset="/img/loading.gif" alt="流程图"></p>
</li>
</ol>
<h2 id="日志分级输出"><a href="#日志分级输出" class="headerlink" title="日志分级输出"></a>日志分级输出</h2><p>详细请参考resources目录下的logback-spring.xml文件</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219171414.png" srcset="/img/loading.gif" alt="日志"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219171501.png" srcset="/img/loading.gif" alt="日志分级"></p>
<h2 id="发送邮件功能-非aliyun实现"><a href="#发送邮件功能-非aliyun实现" class="headerlink" title="发送邮件功能 (非aliyun实现)"></a>发送邮件功能 (非aliyun实现)</h2><ul>
<li>邮件设置<ul>
<li>启用客户端SMTP服务</li>
</ul>
</li>
<li>Spring Email<ul>
<li>导入jar包</li>
<li>邮箱参数配置</li>
<li>使用 <strong>JavaMailSender</strong> 发送邮件</li>
</ul>
</li>
<li>模版引擎<ul>
<li>使用 <strong>Thymeleaf</strong> 发送 <strong>HTML</strong> 邮件</li>
</ul>
</li>
</ul>
<h3 id="开发流程概括-1"><a href="#开发流程概括-1" class="headerlink" title="开发流程概括"></a>开发流程概括</h3><ol>
<li><p>确保邮箱服务开启</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219172636.png" srcset="/img/loading.gif" alt="邮箱服务"></p>
</li>
<li><p>Maven导入</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>配置文件</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-comment">#MailProperties</span>
<span class="hljs-attr">mail:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">smtp.163.com</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">465</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">username</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">pwd</span>
  <span class="hljs-attr">protocol:</span> <span class="hljs-string">smtps</span>
  <span class="hljs-attr">properties:</span>
    <span class="hljs-attr">smtp:</span>
      <span class="hljs-attr">ssl:</span>
        <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span></code></pre></div>
</li>
<li><p>编写MailClient的工具类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MailClient</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(MailClient.class);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JavaMailSender mailSender;

    <span class="hljs-meta">@Value(&quot;$&#123;spring.mail.username&#125;&quot;)</span>
    <span class="hljs-keyword">private</span> String mailFrom;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMail</span><span class="hljs-params">(String mailTo, String title, String content)</span></span>&#123;

        <span class="hljs-keyword">try</span> &#123;
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = <span class="hljs-keyword">new</span> MimeMessageHelper(mimeMessage);
            helper.setFrom(mailFrom);
            helper.setTo(mailTo);
            helper.setSubject(title);
            helper.setText(content,<span class="hljs-keyword">true</span>);

            mailSender.send(helper.getMimeMessage());
        &#125; <span class="hljs-keyword">catch</span> (MessagingException e) &#123;
            logger.error(<span class="hljs-string">&quot;邮件发送失败：&quot;</span>+e.getMessage());
        &#125;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>测试 (省略，请查看test包下的MailTest)</p>
</li>
</ol>
<h2 id="开放注册功能"><a href="#开放注册功能" class="headerlink" title="开放注册功能"></a>开放注册功能</h2><ul>
<li>访问注册页面<ul>
<li>点击顶部区域内的链接，打开注册页面</li>
</ul>
</li>
<li>提交注册数据<ul>
<li>通过表单提交数据</li>
<li>服务端验证账号是否已存在、邮箱是否已注册。</li>
<li>服务端发送激活邮件。</li>
</ul>
</li>
<li>激活注册账号<ul>
<li>点击邮件中的链接，访问服务端的激活服务。</li>
</ul>
</li>
</ul>
<h3 id="开发流程概括-2"><a href="#开发流程概括-2" class="headerlink" title="开发流程概括"></a>开发流程概括</h3><ol>
<li><p>跳转注册页面</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;
  
    <span class="hljs-meta">@RequestMapping(path = &quot;/register&quot;,method = RequestMethod.GET)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getRegisterPage</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/register&quot;</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>修改主页模版引擎</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-item ml-3 btn-group-vertical&quot;</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;loginUser==null&#125;&quot;</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/register&#125;&quot;</span>&gt;</span>注册<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></code></pre></div>
</li>
<li><p>配置激活邮箱发送时附带的激活链接和Commonslang包</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-comment"># community</span>
<span class="hljs-attr">community:</span>
  <span class="hljs-attr">path:</span>
    <span class="hljs-attr">domain:</span> <span class="hljs-string">http://localhost:8080</span>
    <span class="hljs-attr">upload:</span> <span class="hljs-string">/Users/qiuke/Desktop/nowcoder_source/work/picture</span></code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--    空值比较    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>编写MD5、UUID工具类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommunityUtil</span> </span>&#123;

    <span class="hljs-comment">// 生成随机字符串</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">generateUUID</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);
    &#125;

    <span class="hljs-comment">// md5加密 key为pwd+salt</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">md5</span><span class="hljs-params">(String key)</span></span>&#123;
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(key))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        <span class="hljs-keyword">return</span> DigestUtils.md5DigestAsHex(key.getBytes());
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写UserService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> MailClient mailClient;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> TemplateEngine templateEngine;

<span class="hljs-meta">@Value(&quot;$&#123;community.path.domain&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String domain;

<span class="hljs-meta">@Value(&quot;$&#123;server.servlet.context-path&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String contextPath;

<span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">register</span><span class="hljs-params">(User user)</span></span>&#123;
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

        <span class="hljs-comment">// 空值处理</span>
        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;User参数不能为空&quot;</span>);
        &#125;

        <span class="hljs-keyword">if</span> (StringUtils.isBlank(user.getUsername()))&#123;
            map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>,<span class="hljs-string">&quot;账号不能为空&quot;</span>);
            <span class="hljs-keyword">return</span> map;
        &#125;
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(user.getPassword()))&#123;
            map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>,<span class="hljs-string">&quot;密码不能为空&quot;</span>);
            <span class="hljs-keyword">return</span> map;
        &#125;
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(user.getEmail()))&#123;
            map.put(<span class="hljs-string">&quot;emailMsg&quot;</span>,<span class="hljs-string">&quot;邮箱不能为空&quot;</span>);
            <span class="hljs-keyword">return</span> map;
        &#125;

        User u = userMapper.selectByName(user.getUsername());
        <span class="hljs-keyword">if</span> (u != <span class="hljs-keyword">null</span>)&#123;
            map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>,<span class="hljs-string">&quot;该账号已存在&quot;</span>);
            <span class="hljs-keyword">return</span> map;
        &#125;
        u = userMapper.selectByEmail(user.getEmail());
        <span class="hljs-keyword">if</span> (u != <span class="hljs-keyword">null</span>)&#123;
            map.put(<span class="hljs-string">&quot;emailMsg&quot;</span>,<span class="hljs-string">&quot;该邮箱已存在&quot;</span>);
            <span class="hljs-keyword">return</span> map;
        &#125;

        <span class="hljs-comment">// 注册用户</span>
        user.setSalt(CommunityUtil.generateUUID().substring(<span class="hljs-number">0</span>,<span class="hljs-number">6</span>));
        user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
        user.setType(<span class="hljs-number">0</span>); <span class="hljs-comment">// 普通用户</span>
        user.setStatus(<span class="hljs-number">0</span>); <span class="hljs-comment">// 未激活</span>
        user.setActivationCode(CommunityUtil.generateUUID()); <span class="hljs-comment">// 邮箱激活码</span>
        user.setHeaderUrl(String.format(<span class="hljs-string">&quot;http://images.nowcoder.com/head/%dt.png&quot;</span>, <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">1000</span>))); <span class="hljs-comment">// 牛客网的随机头像</span>
        user.setCreateTime(<span class="hljs-keyword">new</span> Date());

        userMapper.insertUser(user);

        <span class="hljs-comment">// 激活邮件</span>
        Context context = <span class="hljs-keyword">new</span> Context();
        context.setVariable(<span class="hljs-string">&quot;email&quot;</span>, user.getEmail());
        <span class="hljs-comment">// 请求格式为：http://localhost:8080/community/activation/id/code</span>
        <span class="hljs-comment">// 设置了mybatis.configuration.useGeneratedKeys=true,user主键id会自动赋值自增</span>
        String url = domain + contextPath + <span class="hljs-string">&quot;/activation/&quot;</span>  + user.getId() + <span class="hljs-string">&quot;/&quot;</span> + user.getActivationCode();
        context.setVariable(<span class="hljs-string">&quot;url&quot;</span>, url);
        <span class="hljs-comment">// /mail/activation为HTML格式的邮件所在路径</span>
        String process = templateEngine.process(<span class="hljs-string">&quot;/mail/activation&quot;</span>, context);

        mailClient.sendMail(user.getEmail(), <span class="hljs-string">&quot;激活邮件&quot;</span>, process);

        <span class="hljs-keyword">return</span> map;
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219175018.png" srcset="/img/loading.gif" alt="模版引擎"></p>
</li>
<li><p>写LoginController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/register&quot;,method = RequestMethod.POST)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">register</span><span class="hljs-params">(Model model, User user)</span></span>&#123;
    Map&lt;String, Object&gt; map = userService.register(user);
    <span class="hljs-keyword">if</span> (map == <span class="hljs-keyword">null</span> || map.isEmpty())&#123;
        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;注册成功,我们已经向您的邮箱发送了一封激活邮件,请尽快激活！&quot;</span>);
        <span class="hljs-comment">// 点击跳转回首页</span>
        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-string">&quot;/index&quot;</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/operate-result&quot;</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        model.addAttribute(<span class="hljs-string">&quot;usernameMsg&quot;</span>, map.get(<span class="hljs-string">&quot;usernameMsg&quot;</span>));
        model.addAttribute(<span class="hljs-string">&quot;passwordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;passwordMsg&quot;</span>));
        model.addAttribute(<span class="hljs-string">&quot;emailMsg&quot;</span>, map.get(<span class="hljs-string">&quot;emailMsg&quot;</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/register&quot;</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>修改operate-result模版引擎</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219175509.png" srcset="/img/loading.gif" alt="模版引擎"></p>
</li>
<li><p>修改register模版引擎(省略，请查看源代码)</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219175654.png" srcset="/img/loading.gif" alt="模版引擎"></p>
</li>
<li><p>编写常量接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 激活成功</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">int</span> ACTIVATION_SUCCESS = <span class="hljs-number">1</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 激活失败</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">int</span> ACTIVATION_FAILURE = -<span class="hljs-number">1</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 重复激活</span>
<span class="hljs-comment">     */</span>

    <span class="hljs-keyword">int</span> ACTIVATION_REPEAT = <span class="hljs-number">0</span>;
&#125;</code></pre></div>
</li>
<li><p>编写activation 激活函数</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">activation</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String code)</span></span>&#123;
    User user = userMapper.selectById(userId);
    <span class="hljs-keyword">if</span> (user.getStatus() == <span class="hljs-number">1</span>)&#123;
        <span class="hljs-keyword">return</span> ACTIVATION_REPEAT;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (user.getActivationCode().equals(code))&#123;
        userMapper.updateStatus(userId,<span class="hljs-number">1</span>);
        clearCache(userId);
        <span class="hljs-keyword">return</span> ACTIVATION_SUCCESS;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">return</span> ACTIVATION_FAILURE;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写LoginController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// http://localhost:8080/community/activation/id/code</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/activation/&#123;userId&#125;/&#123;code&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">activation</span><span class="hljs-params">(Model model, <span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-keyword">int</span> userId, <span class="hljs-meta">@PathVariable(&quot;code&quot;)</span> String code)</span></span>&#123;
    <span class="hljs-keyword">int</span> activation_code = userService.activation(userId, code);

    <span class="hljs-keyword">if</span> (activation_code == ACTIVATION_SUCCESS)&#123;
        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;激活成功,您的账号已经可以正常使用了！&quot;</span>);
        <span class="hljs-comment">// 点击跳转回首页</span>
        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-string">&quot;/login&quot;</span>);
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (activation_code == ACTIVATION_REPEAT)&#123;
        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;激活无效,您的账号已经激活过了！&quot;</span>);
        <span class="hljs-comment">// 点击跳转回首页</span>
        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-string">&quot;/index&quot;</span>);
    &#125;<span class="hljs-keyword">else</span> &#123;
        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;激活失败,您提供的激活码不正确&quot;</span>);
        <span class="hljs-comment">// 点击跳转回首页</span>
        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-string">&quot;/index&quot;</span>);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/operate-result&quot;</span>;
&#125;    

<span class="hljs-meta">@RequestMapping(path = &quot;/login&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getLoginPage</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/login&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>修改index可以点击注册</p>
</li>
</ol>
<h3 id="流程概括图"><a href="#流程概括图" class="headerlink" title="流程概括图"></a>流程概括图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219181942.png" srcset="/img/loading.gif" alt="注册流程"></p>
<h2 id="生成验证码功能"><a href="#生成验证码功能" class="headerlink" title="生成验证码功能"></a>生成验证码功能</h2><blockquote>
<p>先存session后，后续redis更改项目时，存入redis</p>
</blockquote>
<ul>
<li><p>Kaptcha</p>
<ul>
<li>导入jar包</li>
<li>编写Kaptcha配置类</li>
<li>生成随机字符、生成图片</li>
</ul>
</li>
<li><p>kaptcha手册 <a href="https//code.google.com/archive/p/kaptcha">手册</a></p>
</li>
</ul>
<h3 id="开发流程"><a href="#开发流程" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>Maven导入</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--    验证码工具    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.penggle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kaptcha<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>编写Kaptcha配置类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KaptchaConfig</span> </span>&#123;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Producer <span class="hljs-title">kaptchaProducer</span><span class="hljs-params">()</span></span>&#123;
        Properties properties = <span class="hljs-keyword">new</span> Properties();
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.width&quot;</span>, <span class="hljs-string">&quot;100&quot;</span>);
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.height&quot;</span>, <span class="hljs-string">&quot;40&quot;</span>);
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="hljs-string">&quot;32&quot;</span>);
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="hljs-string">&quot;0,0,0&quot;</span>);
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.string&quot;</span>, <span class="hljs-string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>);
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>);
        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.noise.impl&quot;</span>, <span class="hljs-string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);

        <span class="hljs-comment">// 建议另建properties</span>

        DefaultKaptcha kaptcha = <span class="hljs-keyword">new</span> DefaultKaptcha();
        Config config = <span class="hljs-keyword">new</span> Config(properties);
        kaptcha.setConfig(config);
        <span class="hljs-keyword">return</span> kaptcha;
    &#125;

&#125;</code></pre></div>
</li>
<li><p>编写LoginController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/kaptcha&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getKaptcha</span><span class="hljs-params">(HttpServletResponse response, HttpSession session)</span></span>&#123;
    <span class="hljs-comment">// 生成验证码</span>
    String text = kaptchProducer.createText();
    BufferedImage image = kaptchProducer.createImage(text);

    <span class="hljs-comment">// 验证码文字存入session</span>
    session.setAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>,text);

    <span class="hljs-comment">// 将图片输出给浏览器</span>
    response.setContentType(<span class="hljs-string">&quot;image/png&quot;</span>);
    <span class="hljs-keyword">try</span> &#123;
        OutputStream os = response.getOutputStream();
        ImageIO.write(image, <span class="hljs-string">&quot;png&quot;</span>, os);
    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
        logger.error(<span class="hljs-string">&quot;验证码响应失败：&quot;</span> + e.getMessage());
    &#125;
&#125;</code></pre></div>
</li>
<li><p>修改login页面模版引擎路径</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219183214.png" srcset="/img/loading.gif" alt="模版引擎"></p>
<div class="hljs"><pre><code class="hljs js">&lt;script&gt;
   <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refresh_kaptcha</span>(<span class="hljs-params"></span>) </span>&#123;
      <span class="hljs-keyword">var</span> path = CONTEXT_PATH + <span class="hljs-string">&quot;/kaptcha?p=&quot;</span> + <span class="hljs-built_in">Math</span>.random();
      $(<span class="hljs-string">&quot;#kaptcha&quot;</span>).attr(<span class="hljs-string">&quot;src&quot;</span>, path);
   &#125;
&lt;/script&gt;</code></pre></div>

</li>
</ol>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201219183831.png" srcset="/img/loading.gif" alt="流程图"></p>
<h3 id="登录开发流程"><a href="#登录开发流程" class="headerlink" title="登录开发流程"></a>登录开发流程</h3><ol>
<li><p>生成loginTicket实体类并编写Mapper</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginTicket</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> userId;
    <span class="hljs-keyword">private</span> String ticket;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> status;
    <span class="hljs-keyword">private</span> Date expired;

&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">LoginTicketMapper</span> </span>&#123;

    <span class="hljs-meta">@Insert(&#123;</span>
<span class="hljs-meta">            &quot;insert into login_ticket(user_id,ticket,status,expired) &quot;,</span>
<span class="hljs-meta">            &quot;values(#&#123;userId&#125;,#&#123;ticket&#125;,#&#123;status&#125;,#&#123;expired&#125;)&quot;</span>
<span class="hljs-meta">    &#125;)</span>
    <span class="hljs-meta">@Options(useGeneratedKeys = true,keyProperty = &quot;id&quot;)</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertLoginTicket</span><span class="hljs-params">(LoginTicket loginTicket)</span></span>;

    <span class="hljs-meta">@Select(&#123;</span>
<span class="hljs-meta">            &quot;select id,user_id,ticket,status,expired &quot;,</span>
<span class="hljs-meta">            &quot;from login_ticket &quot;,</span>
<span class="hljs-meta">            &quot;where ticket = #&#123;ticket&#125;&quot;</span>
<span class="hljs-meta">    &#125;)</span>
    <span class="hljs-function">LoginTicket <span class="hljs-title">selectByTicket</span><span class="hljs-params">(String ticket)</span></span>;

    <span class="hljs-meta">@Update(&#123;</span>
<span class="hljs-meta">            &quot;update login_ticket set status = #&#123;status&#125; &quot;,</span>
<span class="hljs-meta">            &quot;where ticket = #&#123;ticket&#125;&quot;</span>
<span class="hljs-meta">    &#125;)</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateStatus</span><span class="hljs-params">(String ticket, <span class="hljs-keyword">int</span> status)</span></span>;

&#125;</code></pre></div>
</li>
<li><p>编写UserService的login方法，一个实现跳转，一个实现登录业务</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">login</span><span class="hljs-params">(String username, String password, <span class="hljs-keyword">int</span> expiredSeconds)</span></span>&#123;
     Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
   
     <span class="hljs-comment">// 空值处理</span>
     <span class="hljs-keyword">if</span> (StringUtils.isBlank(username))&#123;
         map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>,<span class="hljs-string">&quot;账号不能为空！&quot;</span>);
         <span class="hljs-keyword">return</span> map;
     &#125;
     <span class="hljs-keyword">if</span> (StringUtils.isBlank(password))&#123;
         map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>,<span class="hljs-string">&quot;密码不能为空！&quot;</span>);
         <span class="hljs-keyword">return</span> map;
     &#125;
   
     <span class="hljs-comment">// 查询 激活处理</span>
     User user = userMapper.selectByName(username);
     <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;
         map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>,<span class="hljs-string">&quot;账号不存在！&quot;</span>);
         <span class="hljs-keyword">return</span> map;
     &#125;
     <span class="hljs-keyword">if</span> (user.getStatus() == <span class="hljs-number">0</span>)&#123;
         map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>,<span class="hljs-string">&quot;账号未激活！&quot;</span>);
         <span class="hljs-keyword">return</span> map;
     &#125;
   
     <span class="hljs-comment">// 验证密码</span>
     password = CommunityUtil.md5(password + user.getSalt());
     <span class="hljs-keyword">if</span> (!user.getPassword().equals(password))&#123;
         map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>,<span class="hljs-string">&quot;密码不正确！&quot;</span>);
         <span class="hljs-keyword">return</span> map;
     &#125;
   
     <span class="hljs-comment">// 登陆成功 生成登陆凭证</span>
     LoginTicket loginTicket = <span class="hljs-keyword">new</span> LoginTicket();
     loginTicket.setUserId(user.getId());
     loginTicket.setTicket(CommunityUtil.generateUUID());
     loginTicket.setStatus(<span class="hljs-number">0</span>);
     loginTicket.setExpired(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + <span class="hljs-number">1000</span> * expiredSeconds));
     loginTicketMapper.insertLoginTicket(loginTicket);
      <span class="hljs-comment">// 浏览器只需要记录key</span>
      <span class="hljs-comment">// TODO redis</span>
     map.put(<span class="hljs-string">&quot;ticket&quot;</span>, loginTicket.getTicket());
   
     <span class="hljs-keyword">return</span> map;
 &#125;</code></pre></div>
</li>
<li><p>编写LoginController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/login&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getLoginPage</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/login&quot;</span>;
&#125;

<span class="hljs-meta">@RequestMapping(path = &quot;/login&quot;,method = RequestMethod.POST)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">login</span><span class="hljs-params">(String username, String password, String code, Boolean rememberme,</span></span>
<span class="hljs-function"><span class="hljs-params">                    Model model, HttpServletResponse response, <span class="hljs-meta">@CookieValue(&quot;kaptchaOwner&quot;)</span>String kaptchaOwner)</span></span>&#123;
    <span class="hljs-comment">// 最先判断验证码</span>
    String kaptcha = (String) session.getAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>);
  
    <span class="hljs-keyword">if</span> (StringUtils.isBlank(kaptcha)
            || StringUtils.isBlank(code)
            || !kaptcha.equalsIgnoreCase(code))&#123;
        model.addAttribute(<span class="hljs-string">&quot;codeMsg&quot;</span>, <span class="hljs-string">&quot;验证码不正确&quot;</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/login&quot;</span>;
    &#125;

    <span class="hljs-comment">// 前端一直拿不到rememberme为false,便加入这行代码自动false,但能拿到true</span>
    <span class="hljs-keyword">if</span> (rememberme == <span class="hljs-keyword">null</span>)&#123;
        rememberme = <span class="hljs-keyword">false</span>;
    &#125;
    <span class="hljs-comment">// 检查账号密码</span>
    <span class="hljs-keyword">int</span> expiredSeconds = rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;
    Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);
    <span class="hljs-keyword">if</span> (map.containsKey(<span class="hljs-string">&quot;ticket&quot;</span>))&#123;
        Cookie cookie =  <span class="hljs-keyword">new</span> Cookie(<span class="hljs-string">&quot;ticket&quot;</span>, map.get(<span class="hljs-string">&quot;ticket&quot;</span>).toString());
        <span class="hljs-comment">// application.yaml中有</span>
        cookie.setPath(contextPath);
        cookie.setMaxAge(expiredSeconds);
        response.addCookie(cookie);

        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index&quot;</span>;
    &#125;<span class="hljs-keyword">else</span> &#123;
        model.addAttribute(<span class="hljs-string">&quot;usernameMsg&quot;</span>, map.get(<span class="hljs-string">&quot;usernameMsg&quot;</span>));
        model.addAttribute(<span class="hljs-string">&quot;passwordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;passwordMsg&quot;</span>));
        model.addAttribute(<span class="hljs-string">&quot;emailMsg&quot;</span>, map.get(<span class="hljs-string">&quot;emailMsg&quot;</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/login&quot;</span>;
    &#125;

&#125;</code></pre></div>



</li>
</ol>
<p>​     期间对应的工具类常量接口数值为：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 默认状态登录凭证的超时时间</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">int</span> DEFAULT_EXPIRED_SECONDS = <span class="hljs-number">3600</span> * <span class="hljs-number">12</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 记住状态登录凭证的超时时间</span>
<span class="hljs-comment"> */</span>

<span class="hljs-keyword">int</span> REMEMBER_EXPIRED_SECONDS = <span class="hljs-number">3600</span> * <span class="hljs-number">24</span> * <span class="hljs-number">14</span>;</code></pre></div>

<ol start="4">
<li><p>修改模版引擎</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221151740.png" srcset="/img/loading.gif" alt="模版引擎"></p>
<p>代码修改请见源码。</p>
</li>
<li><p>编写UserService logout功能</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">logout</span><span class="hljs-params">(String ticket)</span></span>&#123;
    loginTicketMapper.updateStatus(ticket,<span class="hljs-number">1</span>);
&#125;</code></pre></div>
</li>
<li><p>编写的LoginController logout请求</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/logout&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">logout</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span></span>&#123;
    userService.logout(ticket);
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎导航栏请求</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221152201.png" srcset="/img/loading.gif" alt="模版引擎"></p>
</li>
</ol>
<blockquote>
<p>业务流程图</p>
</blockquote>
<p>   <img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221154233.png" srcset="/img/loading.gif" alt="登录流程"></p>
<p>   <img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221154357.png" srcset="/img/loading.gif" alt="退出功能"></p>
<h2 id="显示登录信息"><a href="#显示登录信息" class="headerlink" title="显示登录信息"></a>显示登录信息</h2><ul>
<li><p>拦截器</p>
<ul>
<li>在请求开始时查询登录用户</li>
<li>在本次请求中持有用户数据</li>
<li>在模版视图上显示用户数据</li>
<li>在请求结束时清理用户数据</li>
</ul>
</li>
</ul>
<ol>
<li><p>原理图</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221155649.png" srcset="/img/loading.gif" alt="原理图"></p>
</li>
<li><p>编写HostHolder持有用户信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 容器作用,持有用户信息,用于代替session对象,线程隔离</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HostHolder</span> </span>&#123;

    <span class="hljs-keyword">private</span> ThreadLocal&lt;User&gt; users = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsers</span><span class="hljs-params">(User user)</span></span>&#123;
        users.set(user);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUsers</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> users.get();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span>&#123;
        users.remove();
    &#125;

&#125;</code></pre></div>
</li>
<li><p>编写登录拦截器(实现CookieUtil)</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CookieUtil</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getValue</span><span class="hljs-params">(HttpServletRequest request, String name)</span></span>&#123;
        <span class="hljs-keyword">if</span> (request == <span class="hljs-keyword">null</span> || name == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数为空！&quot;</span>);
        &#125;

        Cookie[] cookies = request.getCookies();
        <span class="hljs-keyword">if</span> (cookies != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">for</span> (Cookie cookie : cookies) &#123;
                <span class="hljs-keyword">if</span> (cookie.getName().equals(name))&#123;
                    <span class="hljs-keyword">return</span> cookie.getValue();
                &#125;
            &#125;
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginTicketInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    UserService userService;

    <span class="hljs-meta">@Autowired</span>
    HostHolder hostHolder;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

        <span class="hljs-comment">// 从cookie中获取ticket</span>
        String ticket = CookieUtil.getValue(request, <span class="hljs-string">&quot;ticket&quot;</span>);

        <span class="hljs-keyword">if</span> (ticket != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">// 查询</span>
            LoginTicket loginTicket = userService.findLoginTicket(ticket);
            <span class="hljs-comment">// 检测有效</span>
            <span class="hljs-keyword">if</span> (loginTicket != <span class="hljs-keyword">null</span> &amp;&amp; loginTicket.getStatus() == <span class="hljs-number">0</span> &amp;&amp; loginTicket.getExpired().after(<span class="hljs-keyword">new</span> Date()))&#123;
                <span class="hljs-comment">// 根据凭证找到用户</span>
                User user = userService.findUserById(loginTicket.getUserId());
                <span class="hljs-comment">// 在本次请求中持有用户</span>
                hostHolder.setUsers(user);
                <span class="hljs-comment">// 构建用户认证结果 存入SecurityContext 以便与security进行授权(越过了security认证 用了自己的认证 需要自己授权)</span>
            &#125;
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        User user = hostHolder.getUsers();
        <span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span> &amp;&amp; modelAndView != <span class="hljs-keyword">null</span>)&#123;
            modelAndView.addObject(<span class="hljs-string">&quot;loginUser&quot;</span>,user);
        &#125;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        hostHolder.clear();
        SecurityContextHolder.clearContext();
    &#125;
&#125;</code></pre></div>

<p>modelAndView.addObject(“loginUser”,user) </p>
<p>这样user就会被模版引擎拿到</p>
</li>
<li><p>注入到WebMvcConfig</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginTicketInterceptor loginTicketInterceptor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;
        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);

    &#125;
&#125;</code></pre></div>
</li>
<li><p>更改模版引擎</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221160610.png" srcset="/img/loading.gif" alt="模版引擎"></p>
</li>
</ol>
<h2 id="账号设置"><a href="#账号设置" class="headerlink" title="账号设置"></a>账号设置</h2><h3 id="上传文件-头像"><a href="#上传文件-头像" class="headerlink" title="上传文件(头像)"></a>上传文件(头像)</h3><blockquote>
<p>七牛云上传在后续，先实现本地存储</p>
</blockquote>
<ul>
<li>请求POST</li>
<li>表单：enctype = “multipart/form-data”</li>
<li>Spring MVC : 通过MultipartFile处理上传文件<ul>
<li>访问账号设置页面</li>
<li>上传头像</li>
<li>获取头像</li>
</ul>
</li>
</ul>
<h3 id="上传文件开发流程"><a href="#上传文件开发流程" class="headerlink" title="上传文件开发流程"></a>上传文件开发流程</h3><ol>
<li><p>设置跳转请求并配置模版引擎</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSettingPage</span><span class="hljs-params">(Model model)</span> </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/setting&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>yaml文件设置访问路径</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-comment"># community</span>
<span class="hljs-attr">community:</span>
  <span class="hljs-attr">path:</span>
    <span class="hljs-attr">domain:</span> <span class="hljs-string">http://localhost:8080</span>
    <span class="hljs-attr">upload:</span> <span class="hljs-string">路径</span></code></pre></div>
</li>
<li><p>编写UserService更新头像并编写mapper(省略)</p>
<div class="hljs"><pre><code class="hljs java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateHeadUrl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String headerUrl)</span></span>&#123;
<span class="hljs-comment">//        return userMapper.updateHeader(userId, headerUrl);</span>
        <span class="hljs-keyword">int</span> rows = userMapper.updateHeader(userId, headerUrl);
        <span class="hljs-keyword">return</span> rows;
    &#125;</code></pre></div>
</li>
<li><p>编写UserController中upload方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;community.path.upload&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String uploadPath;

<span class="hljs-meta">@RequestMapping(path = &quot;/upload&quot;, method = RequestMethod.POST)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">uploadHeader</span><span class="hljs-params">(MultipartFile headerImage, Model model)</span> </span>&#123;
        <span class="hljs-keyword">if</span> (headerImage == <span class="hljs-keyword">null</span>) &#123;
            model.addAttribute(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;文件还未上传！&quot;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/setting&quot;</span>;
        &#125;

        <span class="hljs-comment">// 获取后缀</span>
        String fileName = headerImage.getOriginalFilename();
        String suffix = fileName.substring(fileName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(suffix)) &#123;
            model.addAttribute(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;文件格式不正确！&quot;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/setting&quot;</span>;
        &#125;

        <span class="hljs-comment">// 生成随机文件名</span>
        fileName = CommunityUtil.generateUUID() + suffix;
        <span class="hljs-comment">// 确定文件存放路径</span>
        File dest = <span class="hljs-keyword">new</span> File(uploadPath + <span class="hljs-string">&quot;/&quot;</span> + fileName);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">// 存文件</span>
            headerImage.transferTo(dest);
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            logger.error(<span class="hljs-string">&quot;上传文件失败：&quot;</span> + e.getMessage());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;上传文件失败，服务器发生异常&quot;</span>, e);
        &#125;

        <span class="hljs-comment">// 更新当前用户头像路径</span>
        <span class="hljs-comment">// web访问路径</span>
        <span class="hljs-comment">// http:localhost:8080/community/user/header/xxx.png</span>
        User user = hostHolder.getUsers();
        String headerUrl = domain + contextPath + <span class="hljs-string">&quot;/user&quot;</span> + <span class="hljs-string">&quot;/header/&quot;</span> + fileName;
        <span class="hljs-keyword">int</span> rows = userService.updateHeadUrl(user.getId(), headerUrl);
        <span class="hljs-keyword">if</span> (rows&gt;<span class="hljs-number">0</span>)&#123;
            model.addAttribute(<span class="hljs-string">&quot;success&quot;</span>,<span class="hljs-string">&quot;成功&quot;</span>);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/setting&quot;</span>;
<span class="hljs-comment">//        return &quot;redirect:/index&quot;;</span>
    &#125;</code></pre></div>
</li>
<li><p>编写UserController中展示头像方法</p>
<div class="hljs"><pre><code class="hljs java">
<span class="hljs-meta">@RequestMapping(path = &quot;/header/&#123;fileName&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getHeader</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;fileName&quot;)</span> String fileName, HttpServletResponse response)</span> </span>&#123;

    <span class="hljs-comment">// 获取服务器存放路径</span>
    String filePath = uploadPath + <span class="hljs-string">&quot;/&quot;</span> + fileName;
    <span class="hljs-comment">// 文件后缀名</span>
    String suffix = fileName.substring(fileName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));
    <span class="hljs-comment">// 响应类型</span>
    response.setContentType(<span class="hljs-string">&quot;image/&quot;</span> + suffix);

    <span class="hljs-keyword">try</span> (
            FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(filePath);
            ServletOutputStream os = response.getOutputStream()
    ) &#123;
        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];
        <span class="hljs-keyword">int</span> length = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> ((length = fis.read(buffer)) != -<span class="hljs-number">1</span>) &#123;
            os.write(buffer, <span class="hljs-number">0</span>, length);
        &#125;
    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
        logger.error(<span class="hljs-string">&quot;读取头像失败&quot;</span> + e.getMessage());
    &#125;

&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
</ol>
<h3 id="更改密码"><a href="#更改密码" class="headerlink" title="更改密码"></a>更改密码</h3><ol>
<li><p>编写UserService中updatePassword方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">updatePassword</span><span class="hljs-params">(String oldPassword, String newPassword, String newPasswordConfim)</span></span>&#123;
    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    <span class="hljs-keyword">if</span>(StringUtils.isBlank(oldPassword))&#123;
        map.put(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>,<span class="hljs-string">&quot;旧密码不能为空！&quot;</span>);
        <span class="hljs-keyword">return</span> map;
    &#125;
    <span class="hljs-keyword">if</span>(StringUtils.isBlank(newPassword))&#123;
        map.put(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>,<span class="hljs-string">&quot;新密码不能为空！&quot;</span>);
        <span class="hljs-keyword">return</span> map;
    &#125;
    <span class="hljs-keyword">if</span>(StringUtils.isBlank(newPasswordConfim))&#123;
        map.put(<span class="hljs-string">&quot;newPasswordConfimMsg&quot;</span>,<span class="hljs-string">&quot;确认密码不能为空！&quot;</span>);
        <span class="hljs-keyword">return</span> map;
    &#125;

    <span class="hljs-keyword">if</span>(oldPassword.equals(newPassword))&#123;
        map.put(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>,<span class="hljs-string">&quot;新密码不能和原密码相同！&quot;</span>);
        <span class="hljs-keyword">return</span> map;
    &#125;

    <span class="hljs-keyword">if</span>(!newPassword.equals(newPasswordConfim))&#123;
        map.put(<span class="hljs-string">&quot;newPasswordConfimMsg&quot;</span>,<span class="hljs-string">&quot;确认密码与新密码不同！&quot;</span>);
        <span class="hljs-keyword">return</span> map;
    &#125;

    User user = hostHolder.getUsers();
    oldPassword=CommunityUtil.md5(oldPassword+user.getSalt());
    <span class="hljs-keyword">if</span>(!oldPassword.equals(user.getPassword()))&#123;
        map.put(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>,<span class="hljs-string">&quot;密码错误！&quot;</span>);
        <span class="hljs-keyword">return</span> map;
    &#125;


    userMapper.updatePassword(user.getId(),CommunityUtil.md5(newPassword+user.getSalt()));
    <span class="hljs-keyword">return</span> map;
&#125;</code></pre></div>
</li>
<li><p>编写Mapper</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updatePassword&quot;</span>&gt;</span>
    update user set password = #&#123;password&#125; where id = #&#123;id&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span></code></pre></div>
</li>
<li><p>编写UserControlle请求</p>
<div class="hljs"><pre><code class="hljs java">
<span class="hljs-meta">@RequestMapping(path = &quot;/updatePassword&quot;, method = RequestMethod.POST)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">updatePasswordByOld</span><span class="hljs-params">(String oldPassword, String newPassword, String newPasswordConfim,</span></span>
<span class="hljs-function"><span class="hljs-params">                                  Model model, <span class="hljs-meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span> </span>&#123;

    Map&lt;String, Object&gt; map = userService.updatePassword(oldPassword, newPassword, newPasswordConfim);
    <span class="hljs-keyword">if</span> (map == <span class="hljs-keyword">null</span> || map.isEmpty()) &#123;
        userService.logout(ticket);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login&quot;</span>;
    &#125;
    model.addAttribute(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>));
    model.addAttribute(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>));
    model.addAttribute(<span class="hljs-string">&quot;newPasswordConfimMsg&quot;</span>, map.get(<span class="hljs-string">&quot;newPasswordConfimMsg&quot;</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/setting&quot;</span>;

&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
</ol>
<h3 id="业务流程图"><a href="#业务流程图" class="headerlink" title="业务流程图"></a>业务流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221163918.png" srcset="/img/loading.gif" alt="业务流程图"></p>
<h2 id="注解实现检查登录状态"><a href="#注解实现检查登录状态" class="headerlink" title="注解实现检查登录状态"></a>注解实现检查登录状态</h2><ul>
<li><p>使用拦截器</p>
<ul>
<li>在方法前标注自定义注解</li>
<li>拦截所有请求，只处理带有该注解的方法</li>
</ul>
</li>
<li><p>自定义注解</p>
<ul>
<li><p>常用元注解</p>
<p>@Target、@Retention、@Document、@Inherited</p>
</li>
<li><p>如何读取注解</p>
<p>Method.getDeclaredAnnotations()</p>
<p>Method.getAnnotation(Class<T> annotationClass)</p>
</li>
</ul>
</li>
</ul>
<h3 id="开发流程-1"><a href="#开发流程-1" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>实现注解</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> LoginRequired &#123;
    
&#125;</code></pre></div>

<img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221165052.png" srcset="/img/loading.gif" alt="包位置" style="zoom:50%;" />
</li>
<li><p>给想要拦截的Controller加上注解</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221165130.png" srcset="/img/loading.gif" alt="加注解"></p>
</li>
<li><p>编写拦截注解的拦截器</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Deprecated</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginRequiredInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    HostHolder hostHolder;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

        <span class="hljs-comment">// 判定拦截对象handler是否为method</span>
        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod)&#123;
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            Method method = handlerMethod.getMethod();
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            <span class="hljs-keyword">if</span> (loginRequired != <span class="hljs-keyword">null</span> &amp;&amp; hostHolder.getUsers() == <span class="hljs-keyword">null</span>)&#123;
                response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/login&quot;</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>给WebMvcConfig添加拦截器</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginTicketInterceptor loginTicketInterceptor;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginRequiredInterceptor loginRequiredInterceptor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;
        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);

        <span class="hljs-comment">//registry.addInterceptor(loginRequiredInterceptor)</span>
        <span class="hljs-comment">//        .excludePathPatterns(&quot;/**/*.css&quot;, &quot;/**/*.js&quot;, &quot;/**/*.png&quot;, &quot;/**/*.jpg&quot;, &quot;/**/*.jpeg&quot;);</span>
&#125;</code></pre></div>





</li>
</ol>
<h1 id="帖子模块"><a href="#帖子模块" class="headerlink" title="帖子模块"></a>帖子模块</h1><h2 id="前缀树过滤敏感词"><a href="#前缀树过滤敏感词" class="headerlink" title="前缀树过滤敏感词"></a>前缀树过滤敏感词</h2><ul>
<li>前缀树<ul>
<li>Trie、字典树、查找树</li>
<li>查找效率高、消耗内存大</li>
<li>字符串检索、词频统计、字符串排序</li>
</ul>
</li>
<li>敏感词过滤<ul>
<li>定义前缀树</li>
<li>根据敏感词，初始化前缀树</li>
<li>编写过滤敏感词的方法</li>
</ul>
</li>
</ul>
<ol>
<li><p>编写前缀树算法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SensitiveFilter</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(SensitiveFilter.class);

    <span class="hljs-comment">// 替换符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String REPLACEMENT = <span class="hljs-string">&quot;*&quot;</span>;

    <span class="hljs-comment">// 根节点</span>
    <span class="hljs-keyword">private</span> TrieNode root = <span class="hljs-keyword">new</span> TrieNode();

    <span class="hljs-comment">// 前缀树过滤</span>
    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrieNode</span></span>&#123;

        <span class="hljs-comment">// 敏感词结束结尾</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isKeywordEnd = <span class="hljs-keyword">false</span>;

        <span class="hljs-comment">// 子节点(key是下级字符,value是下级节点)</span>
        <span class="hljs-keyword">private</span> Map&lt;Character, TrieNode&gt; subNode = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isKeywordEnd</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">return</span> isKeywordEnd;
        &#125;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setKeywordEnd</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> keywordEnd)</span> </span>&#123;
            isKeywordEnd = keywordEnd;
        &#125;

        <span class="hljs-comment">// 添加子节点</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSubNode</span><span class="hljs-params">(Character c, TrieNode node)</span></span>&#123;
            subNode.put(c, node);
        &#125;

        <span class="hljs-comment">// 获取子节点</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> TrieNode <span class="hljs-title">getSubNode</span><span class="hljs-params">(Character c)</span></span>&#123;
            <span class="hljs-keyword">return</span> subNode.get(c);
        &#125;
    &#125;

    <span class="hljs-comment">// 初始化</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;

        <span class="hljs-keyword">try</span>(
                InputStream is = <span class="hljs-keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="hljs-string">&quot;sensitive-words.txt&quot;</span>);
                BufferedReader reader = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(is));
        ) &#123;
            String sensitiveWord;
            <span class="hljs-keyword">while</span> ((sensitiveWord = reader.readLine()) != <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">// 添加到前缀树</span>
                <span class="hljs-keyword">this</span>.addSensitiveWord(sensitiveWord);
            &#125;
        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;
            logger.error(<span class="hljs-string">&quot;加载敏感词文件失败&quot;</span> + e.getMessage());
        &#125;

    &#125;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSensitiveWord</span><span class="hljs-params">(String sensitiveWord)</span> </span>&#123;

        TrieNode tempNode = root;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sensitiveWord.length(); i++) &#123;

            <span class="hljs-keyword">char</span> c = sensitiveWord.charAt(i);
            TrieNode subNode = tempNode.getSubNode(c);
            <span class="hljs-keyword">if</span> (subNode == <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">// 初始化</span>
                subNode = <span class="hljs-keyword">new</span> TrieNode();
                tempNode.addSubNode(c, subNode);
            &#125;

            <span class="hljs-comment">// 改变指针</span>
            tempNode = subNode;

            <span class="hljs-comment">// 设置敏感词结尾标记</span>
            <span class="hljs-keyword">if</span> (i == sensitiveWord.length() - <span class="hljs-number">1</span>)&#123;
                tempNode.setKeywordEnd(<span class="hljs-keyword">true</span>);
            &#125;
        &#125;

    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 过滤敏感词</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> text 待过滤文本</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 过滤后的文本</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">Filter</span><span class="hljs-params">(String text)</span></span>&#123;
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(text))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;

        <span class="hljs-comment">// 指针1 指向树的根</span>
        TrieNode tempNode = root;
        <span class="hljs-comment">// 指针2 指向字符串首位</span>
        <span class="hljs-keyword">int</span> begin = <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 指针3</span>
        <span class="hljs-keyword">int</span> position = <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 结果</span>
        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();

        <span class="hljs-keyword">while</span> (position &lt; text.length())&#123;
            <span class="hljs-keyword">char</span> c = text.charAt(position);

            <span class="hljs-comment">// 跳过符号</span>
            <span class="hljs-keyword">if</span> (isSymbol(c))&#123;
                <span class="hljs-comment">// 若指针1处于根节点,将此符号计入结果,不用过滤,指针2向下走一步</span>
                <span class="hljs-keyword">if</span> (tempNode == root)&#123;
                    sb.append(c);
                    begin++;
                &#125;
                <span class="hljs-comment">// 无论符号在开头、结尾,指针3都向下走一步</span>
                position++;
                <span class="hljs-keyword">continue</span>;
            &#125;

            <span class="hljs-comment">// 检查下级节点</span>
            tempNode = tempNode.getSubNode(c);
            <span class="hljs-keyword">if</span> (tempNode == <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">// 以为begin开头的字符串不是敏感词</span>
                sb.append(text.charAt(begin));
                position = ++ begin;
                tempNode = root;
            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tempNode.isKeywordEnd)&#123;
                <span class="hljs-comment">// 发现敏感词,将begin到position字符串替换掉</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; position - begin + <span class="hljs-number">1</span>; i++) &#123;
                    sb.append(REPLACEMENT);
                &#125;
                begin = ++ position;
                tempNode = root;
            &#125; <span class="hljs-keyword">else</span> &#123;
                position ++;
            &#125;
        &#125;
        <span class="hljs-comment">// 最后一批字符计入结果</span>
        sb.append(text.substring(begin));

        <span class="hljs-keyword">return</span> sb.toString();
    &#125;

    <span class="hljs-comment">// 判断是否为符号</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isSymbol</span><span class="hljs-params">(Character c)</span></span>&#123;
        <span class="hljs-comment">// c &lt; 0x2E80 || c &gt; 0x9FFF 之间为东亚文字范围</span>
        <span class="hljs-keyword">return</span> !CharUtils.isAsciiAlphanumeric(c) &amp;&amp; (c &lt; <span class="hljs-number">0x2E80</span> || c &gt; <span class="hljs-number">0x9FFF</span>);
    &#125;


&#125;</code></pre></div>
</li>
<li><p>编写sensitive-words.txt，设置要过滤的词</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221165956.png" srcset="/img/loading.gif" alt="过滤词"></p>
</li>
</ol>
<h2 id="发布帖子"><a href="#发布帖子" class="headerlink" title="发布帖子"></a>发布帖子</h2><ul>
<li>采用AJAX请求，实现发布帖子的功能  <ul>
<li>使用jQuery发送AJAX</li>
</ul>
</li>
</ul>
<h3 id="开发流程-2"><a href="#开发流程-2" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>导入fastJson</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.73<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>编写工具类，增加Json转换方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommunityUtil</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getJSONString</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, String msg, Map&lt;String, Object&gt; map)</span></span>&#123;
        JSONObject json = <span class="hljs-keyword">new</span> JSONObject();
        json.put(<span class="hljs-string">&quot;code&quot;</span>, code);
        json.put(<span class="hljs-string">&quot;msg&quot;</span>, msg);
        <span class="hljs-keyword">if</span> (map != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">for</span> (String key :map.keySet())&#123;
                json.put(key, map.get(key));
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> json.toJSONString();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getJSONString</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, String msg)</span></span>&#123;
        <span class="hljs-keyword">return</span> getJSONString(code, msg, <span class="hljs-keyword">null</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getJSONString</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code)</span></span>&#123;
        <span class="hljs-keyword">return</span> getJSONString(code, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);
    &#125;

&#125;</code></pre></div>
</li>
<li><p>discussPost-mapper增加insert</p>
<div class="hljs"><pre><code class="hljs java">&lt;insert id=<span class="hljs-string">&quot;insertDiscussPost&quot;</span> parameterType=<span class="hljs-string">&quot;DiscussPost&quot;</span> keyProperty=<span class="hljs-string">&quot;id&quot;</span>&gt;
    <span class="hljs-function">insert into <span class="hljs-title">discuss_post</span><span class="hljs-params">(&lt;include refid=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;&lt;/include&gt;)</span></span>
<span class="hljs-function">    <span class="hljs-title">values</span> <span class="hljs-params">(#&#123;userId&#125;,#&#123;title&#125;,#&#123;content&#125;,#&#123;type&#125;,#&#123;status&#125;,#&#123;createTime&#125;,#&#123;commentCount&#125;,#&#123;score&#125;)</span></span>
<span class="hljs-function">&lt;/insert&gt;</span></code></pre></div>
</li>
<li><p>DiscussPostService添加add方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addDiscussPost</span><span class="hljs-params">(DiscussPost discussPost)</span></span>&#123;
    <span class="hljs-keyword">if</span> (discussPost == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数不能为空&quot;</span>);
    &#125;

    <span class="hljs-comment">// 转义html标记</span>
    discussPost.setTitle(HtmlUtils.htmlEscape(discussPost.getTitle()));
    discussPost.setContent(HtmlUtils.htmlEscape(discussPost.getContent()));
    <span class="hljs-comment">// 敏感词过滤</span>
    discussPost.setTitle(sensitiveFilter.Filter(discussPost.getTitle()));
    discussPost.setContent(sensitiveFilter.Filter(discussPost.getContent()));

    <span class="hljs-keyword">return</span> discussPostMapper.insertDiscussPost(discussPost);
&#125;</code></pre></div>
</li>
<li><p>便携DiscussPostController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST)</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">addDiscussPost</span><span class="hljs-params">(String title, String content)</span></span>&#123;

    User user = hostHolder.getUsers();
    <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-comment">// 未登陆</span>
        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;用户未登录！&quot;</span>);
    &#125;

    DiscussPost discussPost = <span class="hljs-keyword">new</span> DiscussPost();
    discussPost.setUserId(user.getId());
    discussPost.setTitle(title);
    discussPost.setContent(content);
    discussPost.setCreateTime(<span class="hljs-keyword">new</span> Date());

    <span class="hljs-comment">// 报错将来统一处理</span>
    discussPostService.addDiscussPost(discussPost);
&#125;</code></pre></div>
</li>
<li><p>修改前端</p>
<div class="hljs"><pre><code class="hljs js">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
   $(<span class="hljs-string">&quot;#publishBtn&quot;</span>).click(publish);
&#125;);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">publish</span>(<span class="hljs-params"></span>) </span>&#123;
   $(<span class="hljs-string">&quot;#publishModal&quot;</span>).modal(<span class="hljs-string">&quot;hide&quot;</span>);

   <span class="hljs-comment">// 获取标题和内容</span>
   <span class="hljs-keyword">var</span> title = $(<span class="hljs-string">&quot;#recipient-name&quot;</span>).val();
   <span class="hljs-keyword">var</span> content = $(<span class="hljs-string">&quot;#message-text&quot;</span>).val();
   <span class="hljs-comment">// 发送异步请求(POST)</span>
   $.post(
      CONTEXT_PATH + <span class="hljs-string">&quot;/discuss/add&quot;</span>,
      &#123;<span class="hljs-string">&quot;title&quot;</span>:title,<span class="hljs-string">&quot;content&quot;</span>:content&#125;,
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
         data = $.parseJSON(data);
         <span class="hljs-comment">// 在提示框中显示返回消息</span>
         $(<span class="hljs-string">&quot;#hintBody&quot;</span>).text(data.msg);
         <span class="hljs-comment">// 显示提示框</span>
         $(<span class="hljs-string">&quot;#hintModal&quot;</span>).modal(<span class="hljs-string">&quot;show&quot;</span>);
         <span class="hljs-comment">// 2秒后,自动隐藏提示框</span>
         <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
            $(<span class="hljs-string">&quot;#hintModal&quot;</span>).modal(<span class="hljs-string">&quot;hide&quot;</span>);
            <span class="hljs-comment">// 刷新页面</span>
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
               <span class="hljs-built_in">window</span>.location.reload();
            &#125;
         &#125;, <span class="hljs-number">2000</span>);
      &#125;
   );

&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
</ol>
<h3 id="业务流程图-1"><a href="#业务流程图-1" class="headerlink" title="业务流程图"></a>业务流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221173121.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="帖子详情"><a href="#帖子详情" class="headerlink" title="帖子详情"></a>帖子详情</h2><ul>
<li>index.html在帖子标题上增加访问路径</li>
<li>discuss-detail.html<ul>
<li>处理静态资源访问路径</li>
<li>复用index.html的header区</li>
<li>显示标题、作者、发布时间、正文等内容</li>
</ul>
</li>
</ul>
<h3 id="开发流程-3"><a href="#开发流程-3" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写discussPost-mapper 增select</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDiscussPostById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;DiscussPost&quot;</span> &gt;</span>
    select
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
    from discuss_post
    where id = #&#123;id&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></code></pre></div>
</li>
<li><p>编写discussPostService 增find</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> DiscussPost <span class="hljs-title">findDiscussPostById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;
    <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPostById(id);
&#125;</code></pre></div>
</li>
<li><p>编写DiscussPostController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/detail/&#123;discussPostId&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getDiscussPost</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-keyword">int</span> discussPostId, Page page, Model model)</span></span>&#123;
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute(<span class="hljs-string">&quot;post&quot;</span>, post);

    <span class="hljs-comment">// 获取user得到username 还可以用关联查询 之后改为redis缓存</span>
    User user = userService.findUserById(post.getUserId());
    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/discuss-detail&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>处理模版引擎，详情查看源码</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201221173900.png" srcset="/img/loading.gif" alt="其他省略"></p>
</li>
</ol>
<h2 id="显示评论"><a href="#显示评论" class="headerlink" title="显示评论"></a>显示评论</h2><ul>
<li>数据层<ul>
<li>根据实体查询一页评论数据</li>
<li>根据实体查询评论的数量</li>
</ul>
</li>
<li>业务层<ul>
<li>处理查询评论业务</li>
<li>处理查询评论数量业务</li>
</ul>
</li>
<li>表现层<ul>
<li>显示帖子详情数据时，同时显示帖子所有的评论数据</li>
</ul>
</li>
</ul>
<h3 id="开发流程-4"><a href="#开发流程-4" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写评论pojo</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Comment</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> userId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> entityType;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> entityId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> targetId;
    <span class="hljs-keyword">private</span> String content;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> status;
    <span class="hljs-keyword">private</span> Date createTime;

&#125;</code></pre></div>
</li>
<li><p>编写comment-mapper.xml和CommentMapper基础</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-comment">//@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CommentMapper</span> </span>&#123;

        <span class="hljs-function">List&lt;Comment&gt; <span class="hljs-title">selectCommentsByEntity</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectCountByEntity</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java">&lt;sql id=<span class="hljs-string">&quot;selectFields&quot;</span> &gt;
    id, user_id, entity_type, entity_id, target_id, content, status, create_time
&lt;/sql&gt;
&lt;select id=<span class="hljs-string">&quot;selectCommentsByEntity&quot;</span> resultType=<span class="hljs-string">&quot;Comment&quot;</span>&gt;
    select
    &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from comment
    where status = <span class="hljs-number">0</span>
    and entity_type = #&#123;entityType&#125;
    and entity_id = #&#123;entityId&#125;
    order by create_time asc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=<span class="hljs-string">&quot;selectCountByEntity&quot;</span> resultType=<span class="hljs-string">&quot;int&quot;</span>&gt;
    <span class="hljs-function">select <span class="hljs-title">count</span><span class="hljs-params">(id)</span></span>
<span class="hljs-function">    from comment</span>
<span class="hljs-function">    where status </span>= <span class="hljs-number">0</span>
    and entity_type = #&#123;entityType&#125;
    and entity_id = #&#123;entityId&#125;
&lt;/select&gt;</code></pre></div>
</li>
<li><p>编写service</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CommentMapper commentMapper;
   
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Comment&gt; <span class="hljs-title">findCommentsByEntity</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>&#123;
        <span class="hljs-keyword">return</span> commentMapper.selectCommentsByEntity(entityType, entityId, offset, limit);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findCommentCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        <span class="hljs-keyword">return</span> commentMapper.selectCountByEntity(entityType, entityId);
    &#125;</code></pre></div>
</li>
<li><p>编写DiscussPostController, 丰富/detail/{discussPostId}请求</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/detail/&#123;discussPostId&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getDiscussPost</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-keyword">int</span> discussPostId, Page page, Model model)</span></span>&#123;
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute(<span class="hljs-string">&quot;post&quot;</span>, post);

    <span class="hljs-comment">// 获取user得到username 还可以用关联查询 之后改为redis缓存</span>
    User user = userService.findUserById(post.getUserId());
    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);

    <span class="hljs-comment">// 评论区</span>
    page.setLimit(<span class="hljs-number">5</span>);
    page.setPath(<span class="hljs-string">&quot;/discuss/detail/&quot;</span> + discussPostId);
    page.setRows(post.getCommentCount());

    List&lt;Comment&gt; comments = commentService.findCommentsByEntity(
            ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());
    List&lt;Map&lt;String, Object&gt;&gt; show_comments = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">if</span> (comments != <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">for</span> (Comment comment: comments
             ) &#123;
            Map&lt;String,Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
            <span class="hljs-comment">// 评论</span>
            map.put(<span class="hljs-string">&quot;comment&quot;</span>, comment);
            User userOfComment = userService.findUserById(comment.getUserId());
            <span class="hljs-comment">// 评论作者</span>
            map.put(<span class="hljs-string">&quot;user&quot;</span>, userOfComment);

            <span class="hljs-comment">// 评论也有评论</span>
            <span class="hljs-comment">// 回复不进行分页</span>
            List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(
                    ENTITY_TYPE_COMMENT, comment.getId(), <span class="hljs-number">0</span>, Integer.MAX_VALUE);
            List&lt;Map&lt;String, Object&gt;&gt; show_reply = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
            <span class="hljs-keyword">if</span> (show_reply != <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-keyword">for</span> (Comment reply: replyList
                     ) &#123;
                    Map&lt;String,Object&gt; replyMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
                    replyMap.put(<span class="hljs-string">&quot;reply&quot;</span>, reply);
                    User userOfReply = userService.findUserById(reply.getUserId());
                    replyMap.put(<span class="hljs-string">&quot;user&quot;</span>, userOfReply );
                    <span class="hljs-comment">// 回复目标！</span>
                    User target = reply.getTargetId() == <span class="hljs-number">0</span> ? <span class="hljs-keyword">null</span> : userService.findUserById(reply.getTargetId());
                    replyMap.put(<span class="hljs-string">&quot;target&quot;</span>, target);
                &#125;
            &#125;
            map.put(<span class="hljs-string">&quot;replys&quot;</span>,show_reply);
            <span class="hljs-comment">// 回复数量</span>
            <span class="hljs-keyword">int</span> replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
            map.put(<span class="hljs-string">&quot;replyCount&quot;</span>,replyCount);
            show_comments.add(map);
        &#125;
    &#125;

    model.addAttribute(<span class="hljs-string">&quot;comments&quot;</span>,show_comments);
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/discuss-detail&quot;</span>;
&#125;</code></pre></div>

<p>对应的常量接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 实体类型:帖子</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">int</span> ENTITY_TYPE_POST = <span class="hljs-number">1</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 实体类型:评论</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">int</span> ENTITY_TYPE_COMMENT = <span class="hljs-number">2</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 实体类型:用户</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">int</span> ENTITY_TYPE_USER = <span class="hljs-number">3</span>;</code></pre></div>
</li>
<li><p>修改discuss-detail.html模版引擎(代码众多，查看源文件)</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222143039.png" srcset="/img/loading.gif" alt="模版引擎"></p>
</li>
</ol>
<h3 id="开发流程图"><a href="#开发流程图" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222145118.png" srcset="/img/loading.gif" alt="流程图"></p>
<h1 id="评论私信模块"><a href="#评论私信模块" class="headerlink" title="评论私信模块"></a>评论私信模块</h1><h2 id="添加评论"><a href="#添加评论" class="headerlink" title="添加评论"></a>添加评论</h2><ul>
<li>数据层<ul>
<li>增加评论数据</li>
<li>修改帖子评论的数量</li>
<li>（事务）</li>
</ul>
</li>
<li>业务层<ul>
<li>处理添加评论的业务</li>
<li>先增再更新评论数量</li>
</ul>
</li>
<li>表现层<ul>
<li>处理添加评论数据的请求</li>
<li>设置添加评论的表单</li>
</ul>
</li>
</ul>
<h3 id="开发流程-5"><a href="#开发流程-5" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写CommentMapper 以及mapper文件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertComment</span><span class="hljs-params">(Comment comment)</span></span>;</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertFields&quot;</span> &gt;</span>
        user_id, entity_type, entity_id, target_id, content, status, create_time
<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertComment&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;Comment&quot;</span>&gt;</span>
    insert into comment (<span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>)
    values(#&#123;userId&#125;,#&#123;entityType&#125;,#&#123;entityId&#125;,#&#123;targetId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span></code></pre></div>
</li>
<li><p>编写DiscussPostMapper 更新评论方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateCommentCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">int</span> commentCount)</span></span>;</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateCommentCount&quot;</span> &gt;</span>
    update discuss_post set comment_count = #&#123;commentCount&#125;
    where id = #&#123;id&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span></code></pre></div>
</li>
<li><p>编写DiscussPostService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateCommentCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">int</span> commentCount)</span></span>&#123;
    <span class="hljs-keyword">return</span> discussPostMapper.updateCommentCount(id, commentCount);
&#125;</code></pre></div>
</li>
<li><p>编写CommentService add方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addComment</span><span class="hljs-params">(Comment comment)</span></span>&#123;
    <span class="hljs-comment">// 要过滤</span>
    <span class="hljs-keyword">if</span> (comment == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数为空！&quot;</span>);
    &#125;

    comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));
    comment.setContent(sensitiveFilter.Filter(comment.getContent()));

    <span class="hljs-keyword">int</span> rows = commentMapper.insertComment(comment);

    <span class="hljs-comment">// 更新帖子评论数量</span>
    <span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST)&#123;
        <span class="hljs-keyword">int</span> count = commentMapper.selectCountByEntity(ENTITY_TYPE_POST, comment.getEntityId());
        discussPostService.updateCommentCount(comment.getEntityId(), count);
    &#125;
    <span class="hljs-keyword">return</span> rows;
&#125;</code></pre></div>
</li>
<li><p>编写CommentController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

<span class="hljs-meta">@RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">addComment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span><span class="hljs-keyword">int</span> discussPostId,Comment comment)</span></span>&#123;
    comment.setUserId(hostHolder.getUsers().getId());
    comment.setStatus(<span class="hljs-number">0</span>);
    comment.setCreateTime(<span class="hljs-keyword">new</span> Date());
    commentService.addComment(comment);

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
</ol>
<h3 id="开发流程图-1"><a href="#开发流程图-1" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222150634.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="私信列表-数据库小游戏"><a href="#私信列表-数据库小游戏" class="headerlink" title="私信列表(数据库小游戏)"></a>私信列表(数据库小游戏)</h2><ul>
<li>私信列表<ul>
<li>查询当前会话列表</li>
<li>每个会话只显示一条最新的私信</li>
<li>支持分页</li>
</ul>
</li>
<li>私信详情<ul>
<li>查询某个会话所包含的私信</li>
<li>支持分页显示</li>
</ul>
</li>
</ul>
<h3 id="私信首页和详情开发流程"><a href="#私信首页和详情开发流程" class="headerlink" title="私信首页和详情开发流程"></a>私信首页和详情开发流程</h3><ol>
<li><p>编写MessageMapper 添加方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MessageMapper</span> </span>&#123;

    <span class="hljs-comment">// 查询当前用户会话列表,针对每个会话只返回一条最新私信</span>
    <span class="hljs-function">List&lt;Message&gt; <span class="hljs-title">selectConversations</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>;

    <span class="hljs-comment">// 查询当前用户会话数量</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectConversationCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>;

    <span class="hljs-comment">// 查询某个会话所包含的私信列表</span>
    <span class="hljs-function">List&lt;Message&gt; <span class="hljs-title">selectLetters</span><span class="hljs-params">(String conversationId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>;

    <span class="hljs-comment">// 查询某个会话所包含的私信数量</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectLetterCount</span><span class="hljs-params">(String conversationId)</span></span>;

    <span class="hljs-comment">// 查询未读私信数量,查询总未读,查询对某用户未读需动态conversationId</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectLetterUnreadCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String conversationId)</span></span>;
&#125;</code></pre></div>
</li>
<li><p>编写mapper文件</p>
<div class="hljs"><pre><code class="hljs java">&lt;sql id=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;
    id,from_id,to_id,conversation_id,content,status,create_time
&lt;/sql&gt;

&lt;sql id=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;
    from_id,to_id,conversation_id,content,status,create_time
&lt;/sql&gt;

&lt;!--  获取每个通话中最新的一条消息  --&gt;
&lt;select id=<span class="hljs-string">&quot;selectConversations&quot;</span> resultType=<span class="hljs-string">&quot;Message&quot;</span>&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from message
    <span class="hljs-function">where id <span class="hljs-title">in</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">        select max(id)</span> from message</span>
<span class="hljs-function">        where status !</span>= <span class="hljs-number">2</span>
        and from_id != <span class="hljs-number">1</span>
        and (from_id = #&#123;userId&#125; or to_id = #&#123;userId&#125;)
        group by conversation_id
    )
    order by create_time desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=<span class="hljs-string">&quot;selectConversationCount&quot;</span> resultType=<span class="hljs-string">&quot;int&quot;</span>&gt;
    <span class="hljs-function">select <span class="hljs-title">count</span><span class="hljs-params">(m.maxid)</span> <span class="hljs-title">from</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">        select max(id)</span> as maxid from message</span>
<span class="hljs-function">        where status !</span>= <span class="hljs-number">2</span>
        and from_id != <span class="hljs-number">1</span>
        and (from_id = #&#123;userId&#125; or to_id = #&#123;userId&#125;)
        group by conversation_id
    )as m
&lt;/select&gt;

&lt;select id=<span class="hljs-string">&quot;selectLetters&quot;</span> resultType=<span class="hljs-string">&quot;Message&quot;</span>&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from message
    where status != <span class="hljs-number">2</span>
    and from_id != <span class="hljs-number">1</span>
    and conversation_id = #&#123;conversationId&#125;
    order by create_time desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=<span class="hljs-string">&quot;selectLetterCount&quot;</span> resultType=<span class="hljs-string">&quot;int&quot;</span>&gt;
    <span class="hljs-function">select <span class="hljs-title">count</span><span class="hljs-params">(id)</span></span>
<span class="hljs-function">    from message</span>
<span class="hljs-function">    where status !</span>= <span class="hljs-number">2</span>
    and from_id != <span class="hljs-number">1</span>
    and conversation_id = #&#123;conversationId&#125;
&lt;/select&gt;

&lt;select id=<span class="hljs-string">&quot;selectLetterUnreadCount&quot;</span> resultType=<span class="hljs-string">&quot;int&quot;</span>&gt;
    <span class="hljs-function">select <span class="hljs-title">count</span><span class="hljs-params">(id)</span></span>
<span class="hljs-function">    from message</span>
<span class="hljs-function">    where status </span>= <span class="hljs-number">0</span>
    and from_id != <span class="hljs-number">1</span>
    and to_id = #&#123;userId&#125;
    &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;conversationId!=null&quot;</span>&gt;
        and conversation_id = #&#123;conversationId&#125;
    &lt;/if&gt;
&lt;/select&gt;</code></pre></div>
</li>
<li><p>编写MessageService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MessageMapper messageMapper;

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title">findConversations</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>&#123;
        <span class="hljs-keyword">return</span> messageMapper.selectConversations(userId, offset, limit);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findConversationCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
        <span class="hljs-keyword">return</span> messageMapper.selectConversationCount(userId);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title">findLetters</span><span class="hljs-params">(String conversationId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>&#123;
        <span class="hljs-keyword">return</span> messageMapper.selectLetters(conversationId, offset, limit);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findLetterCount</span><span class="hljs-params">(String conversationId)</span></span>&#123;
        <span class="hljs-keyword">return</span> messageMapper.selectLetterCount(conversationId);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findeLetterUnreadCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String conversationId)</span></span>&#123;
        <span class="hljs-keyword">return</span> messageMapper.selectLetterUnreadCount(userId, conversationId);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写MessageController 展示私信首页</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/list&quot;,method = RequestMethod.GET)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessageList</span><span class="hljs-params">(Model model, Page page)</span></span>&#123;
        User user = hostHolder.getUsers();
        <span class="hljs-comment">// 设置分页信息</span>
        page.setPath(<span class="hljs-string">&quot;/message/list&quot;</span>);
        page.setLimit(<span class="hljs-number">5</span>);
        page.setRows(messageService.findConversationCount(user.getId()));

        List&lt;Message&gt; conversations = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit());
        List&lt;Map&lt;String, Object&gt;&gt; show_conversations = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (Message m: conversations
             ) &#123;
            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
            map.put(<span class="hljs-string">&quot;conversation&quot;</span>, m);
            map.put(<span class="hljs-string">&quot;unreadCount&quot;</span>, messageService.findeLetterUnreadCount(user.getId(), m.getConversationId()));
            map.put(<span class="hljs-string">&quot;letterCount&quot;</span>, messageService.findLetterCount(m.getConversationId()));

            <span class="hljs-keyword">int</span> targetId = user.getId() == m.getFromId() ? m.getToId() : m.getFromId();
            map.put(<span class="hljs-string">&quot;targetUser&quot;</span>, userService.findUserById(targetId));
            show_conversations.add(map);
        &#125;
        model.addAttribute(<span class="hljs-string">&quot;conversations&quot;</span>, show_conversations);
        <span class="hljs-comment">// 查询未读消息数量</span>
        <span class="hljs-keyword">int</span> unreadCountAll = messageService.findeLetterUnreadCount(user.getId(), <span class="hljs-keyword">null</span>);
        model.addAttribute(<span class="hljs-string">&quot;unreadCountAll&quot;</span>, unreadCountAll);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/letter&quot;</span>;
    &#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
<li><p>编写MessageController 展示私信详情页面</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/detail/&#123;conversationId&#125;&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessageDetail</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String conversationId, Model model, Page page)</span></span>&#123;
    page.setPath(<span class="hljs-string">&quot;/message/detail/&quot;</span>+conversationId);
    page.setRows(messageService.findLetterCount(conversationId));
    page.setLimit(<span class="hljs-number">5</span>);

    List&lt;Message&gt; letters = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String, Object&gt;&gt; show_letters = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">for</span> (Message m:letters
         ) &#123;
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        map.put(<span class="hljs-string">&quot;letter&quot;</span>, m);
        map.put(<span class="hljs-string">&quot;fromUser&quot;</span>, userService.findUserById(m.getFromId()));
        show_letters.add(map);
    &#125;
    model.addAttribute(<span class="hljs-string">&quot;targetUser&quot;</span>, findTargetUser(conversationId));
    model.addAttribute(<span class="hljs-string">&quot;letters&quot;</span>, show_letters);

    <span class="hljs-comment">// 设置已读</span>
    List&lt;Integer&gt; ids = getMessageIds(letters);
    <span class="hljs-keyword">if</span> (ids != <span class="hljs-keyword">null</span> &amp;&amp; !ids.isEmpty())&#123;
        messageService.readMessage(ids);
    &#125;

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/letter-detail&quot;</span>;
&#125;</code></pre></div>

</li>
</ol>
<p>​     期间涉及私有方法:</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">findTargetUser</span><span class="hljs-params">(String conversationId)</span></span>&#123;

    String[] s = conversationId.split(<span class="hljs-string">&quot;_&quot;</span>);
    <span class="hljs-keyword">int</span> id0 = Integer.valueOf(s[<span class="hljs-number">0</span>]);
    <span class="hljs-keyword">int</span> id1 = Integer.valueOf(s[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> (hostHolder.getUsers().getId() == id0)&#123;
        <span class="hljs-keyword">return</span> userService.findUserById(id1);
    &#125;<span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">return</span> userService.findUserById(id0);
    &#125;

&#125;

<span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;Integer&gt; <span class="hljs-title">getMessageIds</span><span class="hljs-params">(List&lt;Message&gt; messageList)</span></span>&#123;
    List&lt;Integer&gt; ids = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">if</span> (messageList!=<span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">for</span> (Message message :messageList
                ) &#123;
            <span class="hljs-keyword">if</span> (hostHolder.getUsers().getId() == message.getToId() &amp;&amp; message.getStatus() == <span class="hljs-number">0</span>)&#123;
                <span class="hljs-comment">// 接收者身份</span>
                ids.add(message.getId());
            &#125;
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> ids;
&#125;</code></pre></div>



<h3 id="开发流程图-2"><a href="#开发流程图-2" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222160141.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="发送私信"><a href="#发送私信" class="headerlink" title="发送私信"></a>发送私信</h2><ul>
<li><p>发送私信</p>
<ul>
<li>采用异步的方式发送私信</li>
<li>发送成功后刷新私信列表</li>
</ul>
</li>
<li><p>设置已读</p>
</li>
</ul>
<h3 id="开发流程-6"><a href="#开发流程-6" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写MessageMapper以及mapper文件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertMessage</span><span class="hljs-params">(Message message)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateMessageStatus</span><span class="hljs-params">(List&lt;Integer&gt; ids, <span class="hljs-keyword">int</span> status)</span></span>;</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertMessage&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;Message&quot;</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span>
    insert into message(<span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>)
    values(#&#123;fromId&#125;,#&#123;toId&#125;,#&#123;conversationId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateMessageStatus&quot;</span>&gt;</span>
    update message set status = #&#123;status&#125;
    where id in
    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;ids&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;(&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span>&gt;</span>
        #&#123;id&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span></code></pre></div>
</li>
<li><p>编写MessageService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertLetter</span><span class="hljs-params">(Message message)</span></span>&#123;
    <span class="hljs-comment">// 敏感词过滤</span>
    message.setContent(HtmlUtils.htmlEscape(message.getContent()));
    message.setContent(sensitiveFilter.Filter(message.getContent()));
    <span class="hljs-keyword">return</span> messageMapper.insertMessage(message);
&#125;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">readMessage</span><span class="hljs-params">(List&lt;Integer&gt; ids)</span></span>&#123;
    <span class="hljs-keyword">return</span> messageMapper.updateMessageStatus(ids, <span class="hljs-number">1</span>);
&#125;</code></pre></div>
</li>
<li><p>编写MessageController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/send&quot;,method = RequestMethod.POST)</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">sendMessage</span><span class="hljs-params">(String toName, String content)</span></span>&#123;
    User toUser = userService.findUserByUsername(toName);
    <span class="hljs-keyword">if</span> (toUser == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;目标用户不存在&quot;</span>);
    &#125;

    Message message = <span class="hljs-keyword">new</span> Message();
    message.setFromId(hostHolder.getUsers().getId());
    message.setToId(toUser.getId());
    <span class="hljs-keyword">if</span> (message.getFromId() &lt; message.getToId())&#123;
        message.setConversationId(message.getFromId()+<span class="hljs-string">&quot;_&quot;</span>+message.getToId());
    &#125;<span class="hljs-keyword">else</span> &#123;
        message.setConversationId(message.getToId()+<span class="hljs-string">&quot;_&quot;</span>+message.getFromId());
    &#125;
    message.setContent(content);
    message.setCreateTime(<span class="hljs-keyword">new</span> Date());
    messageService.insertLetter(message);

    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>);
&#125;</code></pre></div>
</li>
<li><p>编写js</p>
<div class="hljs"><pre><code class="hljs java">$(function()&#123;
   $(<span class="hljs-string">&quot;#sendBtn&quot;</span>).click(send_letter);
   $(<span class="hljs-string">&quot;.close&quot;</span>).click(delete_msg);
&#125;);

<span class="hljs-function">function <span class="hljs-title">send_letter</span><span class="hljs-params">()</span> </span>&#123;
   $(<span class="hljs-string">&quot;#sendModal&quot;</span>).modal(<span class="hljs-string">&quot;hide&quot;</span>);

   <span class="hljs-keyword">var</span> toName = $(<span class="hljs-string">&quot;#recipient-name&quot;</span>).val();
   <span class="hljs-keyword">var</span> content = $(<span class="hljs-string">&quot;#message-text&quot;</span>).val();
   $.post(
      CONTEXT_PATH + <span class="hljs-string">&quot;/message/send&quot;</span>,
      &#123;<span class="hljs-string">&quot;toName&quot;</span>:toName,<span class="hljs-string">&quot;content&quot;</span>:content&#125;,
      function(data) &#123;
         data = $.parseJSON(data);
         <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
            $(<span class="hljs-string">&quot;#hintBody&quot;</span>).text(<span class="hljs-string">&quot;发送成功!&quot;</span>);
         &#125; <span class="hljs-keyword">else</span> &#123;
            $(<span class="hljs-string">&quot;#hintBody&quot;</span>).text(data.msg);
         &#125;

         $(<span class="hljs-string">&quot;#hintModal&quot;</span>).modal(<span class="hljs-string">&quot;show&quot;</span>);
         setTimeout(function()&#123;
            $(<span class="hljs-string">&quot;#hintModal&quot;</span>).modal(<span class="hljs-string">&quot;hide&quot;</span>);
            location.reload();
         &#125;, <span class="hljs-number">2000</span>);
      &#125;
   );
&#125;

<span class="hljs-function">function <span class="hljs-title">delete_msg</span><span class="hljs-params">()</span> </span>&#123;
   <span class="hljs-comment">// TODO 删除数据</span>
   $(<span class="hljs-keyword">this</span>).parents(<span class="hljs-string">&quot;.media&quot;</span>).remove();
&#125;</code></pre></div>



</li>
</ol>
<h3 id="开发流程-7"><a href="#开发流程-7" class="headerlink" title="开发流程"></a>开发流程</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222161836.png" srcset="/img/loading.gif" alt="设置未读"></p>
<h1 id="项目管理模块"><a href="#项目管理模块" class="headerlink" title="项目管理模块"></a>项目管理模块</h1><h2 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h2><ul>
<li>@ControllerAdvice<ul>
<li>用于修饰类,表示该类是Controller的全局配置类。</li>
<li>在此类中，可以对Controller进行如下三种全局配置:异常处理方案、绑定数据方案、绑定参数方案。</li>
</ul>
</li>
<li>@ExceptionHandler<ul>
<li>用于修饰方法，该方法会在Controller出现异常后被调用，用于处理捕获到的异常。</li>
</ul>
</li>
<li>@ModelAttribute<ul>
<li>用于修饰方法，该方法会在Controller方法执行前被调用，用 于为Model对象绑定参数。</li>
</ul>
</li>
<li>@DataBinder<ul>
<li>用于修饰方法，该方法会在Controller方法执行前被调用，用于绑定参数的转换器。</li>
</ul>
</li>
</ul>
<h3 id="error页面"><a href="#error页面" class="headerlink" title="error页面"></a>error页面</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222164736.png" srcset="/img/loading.gif" alt="error"></p>
<h3 id="统一异常处理-1"><a href="#统一异常处理-1" class="headerlink" title="统一异常处理"></a>统一异常处理</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/error&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getErrorPage</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error/500&quot;</span>;
&#125;

<span class="hljs-comment">// 拒绝访问时的提示页面</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/denied&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getDeniedPage</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/error/404&quot;</span>;
&#125;</code></pre></div>

<h3 id="Controller全局配置类"><a href="#Controller全局配置类" class="headerlink" title="Controller全局配置类"></a>Controller全局配置类</h3><blockquote>
<p>不需要对任何Controller加处理，只需要编写全局配置类</p>
</blockquote>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ControllerAdvice(annotations = Controller.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExceptionAdvice</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class);

    <span class="hljs-meta">@ExceptionHandler(&#123;Exception.class&#125;)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handlerException</span><span class="hljs-params">(Exception e, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        logger.error(<span class="hljs-string">&quot;服务器发生异常&quot;</span> + e.getMessage());
        <span class="hljs-keyword">for</span> (StackTraceElement element : e.getStackTrace())&#123;
            logger.error(element.toString());
        &#125;

        String xRequestedWith = request.getHeader(<span class="hljs-string">&quot;x-requested-with&quot;</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith))&#123;
            <span class="hljs-comment">// 异步请求</span>
            response.setContentType(<span class="hljs-string">&quot;application/plain;charset=utf-8&quot;</span>);
            PrintWriter writer = response.getWriter();
            writer.write(CommunityUtil.getJSONString(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;服务器异常&quot;</span>));
        &#125;<span class="hljs-keyword">else</span> &#123;
            response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/error&quot;</span>);
        &#125;

    &#125;

&#125;</code></pre></div>



<h2 id="统一记录日志"><a href="#统一记录日志" class="headerlink" title="统一记录日志"></a>统一记录日志</h2><ul>
<li>AOP实现<ul>
<li><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222165608.png" srcset="/img/loading.gif" alt="AOP"></li>
</ul>
</li>
</ul>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222170059.png" srcset="/img/loading.gif" alt="原理图"></p>
<p>详细原理查看Spring AOP</p>
<h3 id="Aspect实现AOP"><a href="#Aspect实现AOP" class="headerlink" title="Aspect实现AOP"></a>Aspect实现AOP</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceLogAspect</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(ServiceLogAspect.class);

    <span class="hljs-meta">@Pointcut(&quot;execution(* com.nowcoder.community.service.*.*(..))&quot;)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pointcut</span><span class="hljs-params">()</span></span>&#123;&#125;

    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">(JoinPoint joinPoint)</span></span>&#123;
        <span class="hljs-comment">// 用户[ip],在[xxx]时间 访问[com.xxx.xxx]功能</span>
        ServletRequestAttributes attributes =(ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">if</span> (attributes == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">// 是特殊调用 kafka</span>
            <span class="hljs-keyword">return</span>;
        &#125;
        HttpServletRequest request = attributes.getRequest();
        String ip = request.getRemoteHost();
        String now = <span class="hljs-keyword">new</span> SimpleDateFormat(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="hljs-keyword">new</span> Date());

        String classname = joinPoint.getSignature().getDeclaringTypeName() + <span class="hljs-string">&quot;.&quot;</span> + joinPoint.getSignature().getName();

        logger.info(String.format(<span class="hljs-string">&quot;用户[%s],在[%s],访问了[%s]&quot;</span>, ip, now, classname));
    &#125;
&#125;</code></pre></div>





<h1 id="点赞关注模块"><a href="#点赞关注模块" class="headerlink" title="点赞关注模块"></a>点赞关注模块</h1><h2 id="整合redis"><a href="#整合redis" class="headerlink" title="整合redis"></a>整合redis</h2><h3 id="开发流程-8"><a href="#开发流程-8" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>引入依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>配置redis</p>
<p>ymal配置：</p>
<div class="hljs"><pre><code class="hljs yaml">
<span class="hljs-attr">spring:</span>
  <span class="hljs-comment">#RedisProperties</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">database:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span></code></pre></div>

<p>编写配置类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisConfig</span> </span>&#123;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span></span>&#123;
        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> RedisTemplate&lt;&gt;();
        template.setConnectionFactory(factory);

        <span class="hljs-comment">// 设置key序列化方式</span>
        template.setKeySerializer(RedisSerializer.string());
        <span class="hljs-comment">// 设置value序列化方式</span>
        template.setValueSerializer(RedisSerializer.json());
        <span class="hljs-comment">// 设置hash key序列化方式</span>
        template.setHashKeySerializer(RedisSerializer.string());
        <span class="hljs-comment">// 设置hash value序列化方式</span>
        template.setHashValueSerializer(RedisSerializer.json());

        template.afterPropertiesSet();

        <span class="hljs-keyword">return</span> template;
    &#125;

&#125;</code></pre></div>
</li>
<li><p>测试</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222170723.png" srcset="/img/loading.gif" alt="测试"></p>
<p>测试类在测试包下，可自行使用</p>
</li>
</ol>
<h2 id="点赞、取消赞"><a href="#点赞、取消赞" class="headerlink" title="点赞、取消赞"></a>点赞、取消赞</h2><ul>
<li>点赞<ul>
<li>支持对帖子、评论点赞</li>
<li>第一次点赞、第二次取消点赞</li>
</ul>
</li>
<li>首页点赞数量<ul>
<li>统计帖子点赞数量</li>
</ul>
</li>
<li>详情页点赞数量<ul>
<li>统计点赞数量</li>
<li>显示点赞状态</li>
</ul>
</li>
</ul>
<h3 id="帖子点赞开发流程"><a href="#帖子点赞开发流程" class="headerlink" title="帖子点赞开发流程"></a>帖子点赞开发流程</h3><ol>
<li><p>编写RedisKeyUtil 设置业务key</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisKeyUtil</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SPILIT = <span class="hljs-string">&quot;:&quot;</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_ENTITY_LIKE = <span class="hljs-string">&quot;like:entity&quot;</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_USER_LIKE = <span class="hljs-string">&quot;like:user&quot;</span>;

    <span class="hljs-comment">// 某个实体赞的key</span>
    <span class="hljs-comment">// 格式:  like:entity:entityType:entityId -&gt; set(userId)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getEntityLikeKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        <span class="hljs-keyword">return</span> PREFIX_ENTITY_LIKE + SPILIT + entityType + SPILIT + entityId;
    &#125;

    <span class="hljs-comment">// 某个用户的赞</span>
    <span class="hljs-comment">// 格式:  like:user:userid -&gt; int</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUserLikeKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
        <span class="hljs-keyword">return</span> PREFIX_USER_LIKE + SPILIT + userId;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写LikeService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LikeService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

    <span class="hljs-comment">// 点赞</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">like</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId, <span class="hljs-keyword">int</span> entityUserId)</span></span>&#123;
        redisTemplate.execute(<span class="hljs-keyword">new</span> SessionCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(RedisOperations redisOperations)</span> <span class="hljs-keyword">throws</span> DataAccessException </span>&#123;
                <span class="hljs-comment">// 实体用户同时更新 保证事务性</span>
                String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
                String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);
                Boolean isMember = redisOperations.opsForSet().isMember(entityLikeKey, userId);

                redisOperations.multi();

                <span class="hljs-keyword">if</span> (isMember)&#123;
                    <span class="hljs-comment">// 已经点赞</span>
                    redisOperations.opsForSet().remove(entityLikeKey, userId);
                    redisOperations.opsForValue().decrement(userLikeKey);
                &#125;<span class="hljs-keyword">else</span> &#123;
                    redisOperations.opsForSet().add(entityLikeKey, userId);
                    redisOperations.opsForValue().increment(userLikeKey);
                &#125;
                <span class="hljs-keyword">return</span> redisOperations.exec();
            &#125;
        &#125;);
    &#125;

    <span class="hljs-comment">// 查询某实体(帖子\评论)点赞数量</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">findEntityLikeCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        <span class="hljs-keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);
    &#125;

    <span class="hljs-comment">// 查询对某实体(帖子\评论)点赞状态</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findEntityLikeStatus</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        <span class="hljs-keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
    &#125;

&#125;</code></pre></div>
</li>
<li><p>编写LikeController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LikeController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LikeService likeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HostHolder hostHolder;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

    <span class="hljs-meta">@RequestMapping(path = &quot;/like&quot;, method = RequestMethod.POST)</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">like</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId, <span class="hljs-keyword">int</span> entityUserId, <span class="hljs-keyword">int</span> postId)</span></span>&#123;
        User user = hostHolder.getUsers();
        likeService.like(user.getId(), entityType, entityId, entityUserId);

        <span class="hljs-comment">// 点赞数量和状态</span>
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">int</span> likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
        map.put(<span class="hljs-string">&quot;likeCount&quot;</span>, likeService.findEntityLikeCount(entityType, entityId));
        map.put(<span class="hljs-string">&quot;likeStatus&quot;</span>, likeStatus);

        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, map);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
<li><p>编写js</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">like</span>(<span class="hljs-params">btn, entityType, entityId, entityUserId, postId</span>) </span>&#123;
    $.post(
        CONTEXT_PATH + <span class="hljs-string">&quot;/like&quot;</span>,
        &#123;<span class="hljs-string">&quot;entityType&quot;</span>:entityType,<span class="hljs-string">&quot;entityId&quot;</span>:entityId,<span class="hljs-string">&quot;entityUserId&quot;</span>:entityUserId,<span class="hljs-string">&quot;postId&quot;</span>:postId&#125;,
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            data = $.parseJSON(data);
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
                $(btn).children(<span class="hljs-string">&quot;i&quot;</span>).text(data.likeCount);
                $(btn).children(<span class="hljs-string">&quot;b&quot;</span>).text(data.likeStatus==<span class="hljs-number">1</span>?<span class="hljs-string">&#x27;已赞&#x27;</span>:<span class="hljs-string">&quot;赞&quot;</span>);
            &#125; <span class="hljs-keyword">else</span> &#123;
                alert(data.msg);
            &#125;
        &#125;
    );
&#125;</code></pre></div>
</li>
<li><p>给其他Controller添加查询赞的功能</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222172546.png" srcset="/img/loading.gif" alt="DiscussPostController添加like"></p>
<p>再更改模版引擎即可</p>
</li>
</ol>
<h3 id="获取用户主页获得的赞数开发流程"><a href="#获取用户主页获得的赞数开发流程" class="headerlink" title="获取用户主页获得的赞数开发流程"></a>获取用户主页获得的赞数开发流程</h3><ol>
<li><p>添加RedisKeyUtil</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_USER_LIKE = <span class="hljs-string">&quot;like:user&quot;</span>;
 <span class="hljs-comment">// 某个用户的赞</span>
 <span class="hljs-comment">// 格式:  like:user:userid -&gt; int</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUserLikeKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
     <span class="hljs-keyword">return</span> PREFIX_USER_LIKE + SPILIT + userId;
 &#125;</code></pre></div>
</li>
<li><p>事务化点赞Service，点赞后更新用户获赞数</p>
<div class="hljs"><pre><code class="hljs java">redisTemplate.execute(<span class="hljs-keyword">new</span> SessionCallback() &#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(RedisOperations redisOperations)</span> <span class="hljs-keyword">throws</span> DataAccessException </span>&#123;
        <span class="hljs-comment">// 实体用户同时更新 保证事务性</span>
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);
        Boolean isMember = redisOperations.opsForSet().isMember(entityLikeKey, userId);

        redisOperations.multi();

        <span class="hljs-keyword">if</span> (isMember)&#123;
            <span class="hljs-comment">// 已经点赞</span>
            redisOperations.opsForSet().remove(entityLikeKey, userId);
            redisOperations.opsForValue().decrement(userLikeKey);
        &#125;<span class="hljs-keyword">else</span> &#123;
            redisOperations.opsForSet().add(entityLikeKey, userId);
            redisOperations.opsForValue().increment(userLikeKey);
        &#125;
        <span class="hljs-keyword">return</span> redisOperations.exec();
    &#125;
&#125;);</code></pre></div>
</li>
<li><p>添加用户获得赞个数方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 查询用户获得的点赞数量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findUserLikeCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
    String UserLikeKey = RedisKeyUtil.getUserLikeKey(userId);
    <span class="hljs-keyword">return</span> (Integer) redisTemplate.opsForValue().get(UserLikeKey) == <span class="hljs-keyword">null</span>?<span class="hljs-number">0</span>:(Integer) ((Integer) redisTemplate.opsForValue().get(UserLikeKey)).intValue();

&#125;</code></pre></div>
</li>
<li><p>给Controller和js添加一个entityUserId参数即可（上述点赞代码已给出）</p>
</li>
<li><p>编写UserController 定位个人主页</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 个人主页</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getProfilePage</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-keyword">int</span> userId, Model model)</span> </span>&#123;

    User user = userService.findUserById(userId);
    <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;该用户不存在&quot;</span>);
    &#125;

    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);
    <span class="hljs-comment">// 获赞数量</span>
    <span class="hljs-keyword">int</span> userLikeCount = likeService.findUserLikeCount(userId);
    model.addAttribute(<span class="hljs-string">&quot;userLikeCount&quot;</span>, userLikeCount);

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/profile&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎profile.html</p>
</li>
</ol>
<h3 id="开发流程图-3"><a href="#开发流程图-3" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222180108.png" srcset="/img/loading.gif" alt="开发流程图"></p>
<p>上图应该是 <strong>json装入点赞数、状态</strong> </p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222184143.png" srcset="/img/loading.gif" alt="redisKey"></p>
<h2 id="关注、取消关注"><a href="#关注、取消关注" class="headerlink" title="关注、取消关注"></a>关注、取消关注</h2><ul>
<li>需求<ul>
<li>开发关注、取消关注功能</li>
<li>统计用户的关注数、粉丝数</li>
</ul>
</li>
<li>rediskey<ul>
<li>若A关注B，则A是B的粉丝（Follower），B是A的目标（Followee）</li>
</ul>
</li>
</ul>
<h3 id="开发流程-9"><a href="#开发流程-9" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写RedisKeyUtil</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 关注</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_FOLLOWEE = <span class="hljs-string">&quot;followee&quot;</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_FOLLOWER = <span class="hljs-string">&quot;follower&quot;</span>;
<span class="hljs-comment">// 某个用户关注的实体</span>
<span class="hljs-comment">// 格式: followee:userId:entityType -&gt; zset(entityId, now date()) 时间排序</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getFolloweeKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_FOLLOWEE + SPILIT + userId + SPILIT + entityType;
&#125;
   
<span class="hljs-comment">// 某个实体的粉丝</span>
<span class="hljs-comment">// 格式: follower:entityType:entityId -&gt; zset(userId, now date()) 时间排序</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getFollowerKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_FOLLOWER + SPILIT + entityType + SPILIT + entityId;
&#125;</code></pre></div>
</li>
<li><p>编写FollowService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FollowService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">follow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        redisTemplate.execute(<span class="hljs-keyword">new</span> SessionCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(RedisOperations redisOperations)</span> <span class="hljs-keyword">throws</span> DataAccessException </span>&#123;
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);

                redisOperations.multi();

                redisOperations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());
                redisOperations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());

                <span class="hljs-keyword">return</span> redisOperations.exec();
            &#125;
        &#125;);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unfollow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        redisTemplate.execute(<span class="hljs-keyword">new</span> SessionCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(RedisOperations redisOperations)</span> <span class="hljs-keyword">throws</span> DataAccessException </span>&#123;
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);

                redisOperations.multi();

                redisOperations.opsForZSet().remove(followeeKey, entityId);
                redisOperations.opsForZSet().remove(followerKey, userId);

                <span class="hljs-keyword">return</span> redisOperations.exec();
            &#125;
        &#125;);
    &#125;
 &#125;</code></pre></div>
</li>
<li><p>Service添加查询关注、粉丝数以及关注状态</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 关注列表数量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">findFolloweeCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType)</span></span>&#123;
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
    <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().zCard(followeeKey);
&#125;

<span class="hljs-comment">// 粉丝列表数量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">findFollowerCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
    String followerKey = RedisKeyUtil.getFolloweeKey(entityType, entityId);
    <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().zCard(followerKey);
&#125;

<span class="hljs-comment">// 查询关注状态</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasFollow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
    <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().score(followeeKey, entityId) != <span class="hljs-keyword">null</span>;
&#125;</code></pre></div>
</li>
<li><p>编写FollowController以及js</p>
<div class="hljs"><pre><code class="hljs js">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
   $(<span class="hljs-string">&quot;.follow-btn&quot;</span>).click(follow);
&#125;);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">follow</span>(<span class="hljs-params"></span>) </span>&#123;
   <span class="hljs-keyword">var</span> btn = <span class="hljs-built_in">this</span>;
   <span class="hljs-keyword">if</span>($(btn).hasClass(<span class="hljs-string">&quot;btn-info&quot;</span>)) &#123;
      <span class="hljs-comment">// 关注TA</span>
      $.post(
         CONTEXT_PATH + <span class="hljs-string">&quot;/follow&quot;</span>,
         &#123;<span class="hljs-string">&quot;entityType&quot;</span>:<span class="hljs-number">3</span>,<span class="hljs-string">&quot;entityId&quot;</span>:$(btn).prev().val()&#125;,
         <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            data = $.parseJSON(data);
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
               <span class="hljs-built_in">window</span>.location.reload();
            &#125; <span class="hljs-keyword">else</span> &#123;
               alert(data.msg);
            &#125;
         &#125;
      );
      <span class="hljs-comment">// $(btn).text(&quot;已关注&quot;).removeClass(&quot;btn-info&quot;).addClass(&quot;btn-secondary&quot;);</span>
   &#125; <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-comment">// 取消关注</span>
      $.post(
         CONTEXT_PATH + <span class="hljs-string">&quot;/unfollow&quot;</span>,
         &#123;<span class="hljs-string">&quot;entityType&quot;</span>:<span class="hljs-number">3</span>,<span class="hljs-string">&quot;entityId&quot;</span>:$(btn).prev().val()&#125;,
         <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            data = $.parseJSON(data);
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
               <span class="hljs-built_in">window</span>.location.reload();
            &#125; <span class="hljs-keyword">else</span> &#123;
               alert(data.msg);
            &#125;
         &#125;
      );
      <span class="hljs-comment">//$(btn).text(&quot;关注TA&quot;).removeClass(&quot;btn-secondary&quot;).addClass(&quot;btn-info&quot;);</span>
   &#125;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FollowController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HostHolder hostHolder;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> FollowService followService;

    <span class="hljs-meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">follow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        User user = hostHolder.getUsers();

        followService.follow(user.getId(), entityType, entityId);

        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;已关注&quot;</span>);
    &#125;

    <span class="hljs-meta">@RequestMapping(path = &quot;/unfollow&quot;, method = RequestMethod.POST)</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">unfollow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType, <span class="hljs-keyword">int</span> entityId)</span></span>&#123;
        User user = hostHolder.getUsers();

        followService.unfollow(user.getId(), entityType, entityId);

        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;已取消关注&quot;</span>);
    &#125;</code></pre></div>
</li>
<li><p>编写UserController主页显示请求 添加关注状态</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222181231.png" srcset="/img/loading.gif" alt="usercontroller"></p>
<h3 id="业务流程图-2"><a href="#业务流程图-2" class="headerlink" title="业务流程图"></a>业务流程图</h3></li>
</ol>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222183222.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="关注列表、粉丝列表"><a href="#关注列表、粉丝列表" class="headerlink" title="关注列表、粉丝列表"></a>关注列表、粉丝列表</h2><ul>
<li>业务层<ul>
<li>查询某个用户关注的人，支持分页</li>
<li>查询某个用户的粉丝，支持分页</li>
</ul>
</li>
<li>表现层<ul>
<li>处理请求</li>
<li>编写模版</li>
</ul>
</li>
</ul>
<h3 id="开发流程-10"><a href="#开发流程-10" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写FollowService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 查询关注的用户</span>
<span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; findFollowees(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)&#123;
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);
    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - <span class="hljs-number">1</span>);
    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">if</span> (targetIds == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-keyword">for</span> (Integer targetId :targetIds
            ) &#123;
        User user = userService.findUserById(targetId);
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        map.put(<span class="hljs-string">&quot;user&quot;</span>, user);

        Double time = redisTemplate.opsForZSet().score(followeeKey, targetId);
        map.put(<span class="hljs-string">&quot;userFolloweeDate&quot;</span>, <span class="hljs-keyword">new</span> Date(time.longValue()));

        list.add(map);
    &#125;
    <span class="hljs-keyword">return</span> list;
&#125;

<span class="hljs-comment">// 查询用户的粉丝</span>
<span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; findFollowers(<span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)&#123;
    String followerKey = RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);
    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - <span class="hljs-number">1</span>);
    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">if</span> (targetIds == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-keyword">for</span> (Integer targetId :targetIds
    ) &#123;
        User user = userService.findUserById(targetId);
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        map.put(<span class="hljs-string">&quot;user&quot;</span>, user);

        Double time = redisTemplate.opsForZSet().score(followerKey, targetId);
        map.put(<span class="hljs-string">&quot;userFollowerDate&quot;</span>, <span class="hljs-keyword">new</span> Date(time.longValue()));

        list.add(map);
    &#125;
    <span class="hljs-keyword">return</span> list;
&#125;</code></pre></div>
</li>
<li><p>编写FollowController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/followees/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFollowees</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-keyword">int</span> userId, Page page, Model model)</span></span>&#123;
    User user = userService.findUserById(userId);
    <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;用户不存在&quot;</span>);
    &#125;
    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);

    page.setLimit(<span class="hljs-number">5</span>);
    page.setPath(<span class="hljs-string">&quot;/followees/&quot;</span> + userId);
    page.setRows((<span class="hljs-keyword">int</span>) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));

    <span class="hljs-comment">// 给list加入关注状态</span>
    List&lt;Map&lt;String, Object&gt;&gt; followeesList = followService.findFollowees(userId, page.getOffset(), page.getLimit());
    <span class="hljs-keyword">if</span> (followeesList != <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">for</span> (Map&lt;String, Object&gt; followeeMap : followeesList
                ) &#123;
            <span class="hljs-comment">// 加入当前登陆用户对每个关注列表用户的关注状态</span>
            User followeeUser = (User) followeeMap.get(<span class="hljs-string">&quot;user&quot;</span>);
            followeeMap.put(<span class="hljs-string">&quot;followStatus&quot;</span>, hasFollow(followeeUser.getId()));
        &#125;
    &#125;

    model.addAttribute(<span class="hljs-string">&quot;followees&quot;</span>, followeesList);

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/followee&quot;</span>;
&#125;

<span class="hljs-meta">@RequestMapping(path = &quot;/followers/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFollowers</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-keyword">int</span> userId, Page page, Model model)</span></span>&#123;
    User user = userService.findUserById(userId);
    <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;用户不存在&quot;</span>);
    &#125;
    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);

    page.setLimit(<span class="hljs-number">5</span>);
    page.setPath(<span class="hljs-string">&quot;/followers/&quot;</span> + userId);
    page.setRows((<span class="hljs-keyword">int</span>) followService.findFollowerCount(ENTITY_TYPE_USER, userId));

    <span class="hljs-comment">// 给list加入关注状态</span>
    List&lt;Map&lt;String, Object&gt;&gt; followersList = followService.findFollowers(userId, page.getOffset(), page.getLimit());
    <span class="hljs-keyword">if</span> (followersList != <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">for</span> (Map&lt;String, Object&gt; followerMap : followersList
        ) &#123;
            <span class="hljs-comment">// 加入当前登陆用户对每个关注列表用户的关注状态</span>
            User followerUser = (User) followerMap.get(<span class="hljs-string">&quot;user&quot;</span>);
            followerMap.put(<span class="hljs-string">&quot;followStatus&quot;</span>, hasFollow(followerUser.getId()));
        &#125;
    &#125;

    model.addAttribute(<span class="hljs-string">&quot;followers&quot;</span>, followersList);

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/follower&quot;</span>;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasFollow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
    <span class="hljs-keyword">if</span> (hostHolder.getUsers() == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;

    <span class="hljs-keyword">return</span> followService.hasFollow(hostHolder.getUsers().getId(), ENTITY_TYPE_USER, userId);
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
</li>
</ol>
<h3 id="业务流程图-3"><a href="#业务流程图-3" class="headerlink" title="业务流程图"></a>业务流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222183920.png" srcset="/img/loading.gif" alt="流程图"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201222184215.png" srcset="/img/loading.gif" alt="redisKey"></p>
<h1 id="缓存与消息队列模块"><a href="#缓存与消息队列模块" class="headerlink" title="缓存与消息队列模块"></a>缓存与消息队列模块</h1><ul>
<li>使用Redis存储验证码<ul>
<li>验证码需要频繁的访问与刷新,对性能要求较高。</li>
<li>验证码不需永久保存，通常在很短的时间后就会失效。</li>
<li>分布式部署时，存在Session共享的问题</li>
</ul>
</li>
<li>使用Redis存储登录凭证<ul>
<li>处理每次请求时，都要查询用户的登录凭证，访问的频率非常高。</li>
</ul>
</li>
<li>使用Redis缓存用户信息<ul>
<li>处理每次请求时，都要根据凭证查询用户信息，访问的频率非常高。</li>
</ul>
</li>
</ul>
<h2 id="储存验证码"><a href="#储存验证码" class="headerlink" title="储存验证码"></a>储存验证码</h2><h3 id="储存验证码开发流程"><a href="#储存验证码开发流程" class="headerlink" title="储存验证码开发流程"></a>储存验证码开发流程</h3><ol>
<li><p>编写RedisKeyUtil</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String KAPTCHA = <span class="hljs-string">&quot;kaptcha&quot;</span>;
 <span class="hljs-comment">// 登录验证码</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getKaptchaKey</span><span class="hljs-params">(String owner)</span></span>&#123;
     <span class="hljs-keyword">return</span> KAPTCHA + SPILIT + owner;
 &#125;</code></pre></div>
</li>
<li><p>修改LoginController中/kaptcha请求</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/kaptcha&quot;,method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getKaptcha</span><span class="hljs-params">(HttpServletResponse response)</span></span>&#123;
    <span class="hljs-comment">// 生成验证码</span>
    String text = kaptchProducer.createText();
    BufferedImage image = kaptchProducer.createImage(text);

    <span class="hljs-comment">// 验证码的归属者</span>
    String kaptchaOwner = CommunityUtil.generateUUID();
    <span class="hljs-comment">// 存入cookie</span>
    Cookie cookie = <span class="hljs-keyword">new</span> Cookie(<span class="hljs-string">&quot;kaptchaOwner&quot;</span>, kaptchaOwner);
    cookie.setMaxAge(<span class="hljs-number">60</span>);
    cookie.setPath(contextPath);
    response.addCookie(cookie);

    <span class="hljs-comment">// 验证码文字存入redis</span>
    String kaptchaKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
    redisTemplate.opsForValue().set(kaptchaKey, text, <span class="hljs-number">60</span> , TimeUnit.SECONDS);

    <span class="hljs-comment">// 将图片输出给浏览器</span>
    response.setContentType(<span class="hljs-string">&quot;image/png&quot;</span>);
    <span class="hljs-keyword">try</span> &#123;
        OutputStream os = response.getOutputStream();
        ImageIO.write(image, <span class="hljs-string">&quot;png&quot;</span>, os);
    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
        logger.error(<span class="hljs-string">&quot;验证码响应失败：&quot;</span> + e.getMessage());
    &#125;
&#125;</code></pre></div>
</li>
<li><p>修改LoginController中/login请求</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223090056.png" srcset="/img/loading.gif" alt="redis存验证码"></p>
</li>
</ol>
<h3 id="开发流程图-4"><a href="#开发流程图-4" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223095133.png" srcset="/img/loading.gif" alt="开发流程图"></p>
<h2 id="存储登录凭证"><a href="#存储登录凭证" class="headerlink" title="存储登录凭证"></a>存储登录凭证</h2><h3 id="存储登录凭证开发流程"><a href="#存储登录凭证开发流程" class="headerlink" title="存储登录凭证开发流程"></a>存储登录凭证开发流程</h3><ol>
<li><p>编写redisKeyUtil</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_TICKET = <span class="hljs-string">&quot;ticket&quot;</span>;
 <span class="hljs-comment">// 登录凭证</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getTicketKey</span><span class="hljs-params">(String ticket)</span></span>&#123;
     <span class="hljs-keyword">return</span> PREFIX_TICKET + SPILIT + ticket;
 &#125;</code></pre></div>
</li>
<li><p>废弃LoginTicketMapper(不再MySql存储登录凭证)</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223090329.png" srcset="/img/loading.gif" alt="废弃"></p>
</li>
<li><p>修改UserService login方法</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223090538.png" srcset="/img/loading.gif" alt="redis"></p>
</li>
<li><p>修改UserService logout方法</p>
<div class="hljs"><pre><code class="hljs java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">logout</span><span class="hljs-params">(String ticket)</span></span>&#123;
<span class="hljs-comment">//        loginTicketMapper.updateStatus(ticket,1);</span>
        String redisKey = RedisKeyUtil.getTicketKey(ticket);
        LoginTicket loginTicket =(LoginTicket) redisTemplate.opsForValue().get(redisKey);
        loginTicket.setStatus(<span class="hljs-number">1</span>);
        redisTemplate.opsForValue().set(redisKey, loginTicket);

    &#125;</code></pre></div>
</li>
<li><p>修改findLoginTicket方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> LoginTicket <span class="hljs-title">findLoginTicket</span><span class="hljs-params">(String ticket)</span></span>&#123;
    String redisKey = RedisKeyUtil.getTicketKey(ticket);
    <span class="hljs-keyword">return</span> (LoginTicket) redisTemplate.opsForValue().get(redisKey);
&#125;</code></pre></div>

<p>这样拦截器能通过redis找到</p>
</li>
</ol>
<h3 id="开发流程图-5"><a href="#开发流程图-5" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223095906.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="存储用户信息"><a href="#存储用户信息" class="headerlink" title="存储用户信息"></a>存储用户信息</h2><h3 id="存储用户信息开发流程"><a href="#存储用户信息开发流程" class="headerlink" title="存储用户信息开发流程"></a>存储用户信息开发流程</h3><ol>
<li><p>编写RedisKeyUtil</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_USER = <span class="hljs-string">&quot;user&quot;</span>;
<span class="hljs-comment">// 用户</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUserKey</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_USER + SPILIT + userId;
&#125;</code></pre></div>
</li>
<li><p>修改UserService</p>
<div class="hljs"><pre><code class="hljs java">    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findUserById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;
<span class="hljs-comment">//        return userMapper.selectById(id);</span>
        User user = getCache(id);
        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">// 初始化</span>
            user = initCache(id);
        &#125;

        <span class="hljs-keyword">return</span> user;
    &#125;
    <span class="hljs-comment">// 缓存管理用户信息:</span>
    <span class="hljs-comment">// 1. 优先从缓存中取值</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">getCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
        String redisKey = RedisKeyUtil.getUserKey(userId);
        <span class="hljs-keyword">return</span> (User) redisTemplate.opsForValue().get(redisKey);
    &#125;

    <span class="hljs-comment">// 2. 取不到时初始化缓存数据</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">initCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
        User user = userMapper.selectById(userId);
        String redisKey = RedisKeyUtil.getUserKey(userId);
        redisTemplate.opsForValue().set(redisKey, user, <span class="hljs-number">36000</span>, TimeUnit.SECONDS);
        <span class="hljs-keyword">return</span> user;
    &#125;

    <span class="hljs-comment">// 3. 数据变更时清楚缓存</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
        String redisKey = RedisKeyUtil.getUserKey(userId);
        redisTemplate.delete(redisKey);
    &#125;</code></pre></div>
</li>
<li><p>给相应方法添加清除缓存</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223091454.png" srcset="/img/loading.gif" alt="activation"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223091512.png" srcset="/img/loading.gif" alt="pwd"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223091535.png" srcset="/img/loading.gif" alt="headerUrl"></p>
</li>
</ol>
<h3 id="开发流程图-6"><a href="#开发流程图-6" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223100648.png" srcset="/img/loading.gif" alt="开发流程图"></p>
<h2 id="Spring整合Kafka"><a href="#Spring整合Kafka" class="headerlink" title="Spring整合Kafka"></a>Spring整合Kafka</h2><ul>
<li>引入依赖<ul>
<li>spring-kafka</li>
</ul>
</li>
<li>配置kafka<ul>
<li>配置server、consumer</li>
</ul>
</li>
<li>访问kafka<ul>
<li>生产者</li>
<li>消费者</li>
</ul>
</li>
</ul>
<h3 id="开发流程-11"><a href="#开发流程-11" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>Maven</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--    kafka    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>配置kafka</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment"># KafkaProperties</span>
<span class="hljs-meta">spring.kafka.bootstrap-servers</span>=<span class="hljs-string">localhost:9092</span>
<span class="hljs-meta">spring.kafka.consumer.group-id</span>=<span class="hljs-string">test</span>
<span class="hljs-meta">spring.kafka.consumer.enable-auto-commit</span>=<span class="hljs-string">true</span>
<span class="hljs-meta">spring.kafka.consumer.auto-commit-interval</span>=<span class="hljs-string">3000</span>
<span class="hljs-meta">spring.kafka.listener.missing-topics-fatal</span>=<span class="hljs-string">false</span>
<span class="hljs-comment">#如果无主题会报错 选择false</span></code></pre></div>
</li>
<li><p>检查kafka本地配置</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223101350.png" srcset="/img/loading.gif" alt="kafka"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223101442.png" srcset="/img/loading.gif" alt="与properties对应"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223101528.png" srcset="/img/loading.gif" alt="开端口"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223101557.png" srcset="/img/loading.gif" alt="开端口"></p>
</li>
</ol>
<ol start="4">
<li><p>编写测试类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringRunner.class)</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@ContextConfiguration(classes = CommunityApplication.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaTest</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaProducer kafkaProducer;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKafka</span><span class="hljs-params">()</span> </span>&#123;
        kafkaProducer.sendMessage(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;你好&quot;</span>);
        System.out.println(<span class="hljs-number">1</span>);
        kafkaProducer.sendMessage(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;在吗&quot;</span>);

        <span class="hljs-keyword">try</span> &#123;
            Thread.sleep(<span class="hljs-number">1000</span>);
        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

&#125;

<span class="hljs-meta">@Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducer</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate kafkaTemplate;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(String topic, String content)</span> </span>&#123;
        kafkaTemplate.send(topic, content);
    &#125;
&#125;

<span class="hljs-meta">@Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumer</span> </span>&#123;

    <span class="hljs-meta">@KafkaListener(topics = &#123;&quot;test&quot;&#125;)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleMessage</span><span class="hljs-params">(ConsumerRecord record)</span> </span>&#123;
        System.out.println(record.value()
        );
    &#125;
&#125;</code></pre></div>

<p>单元测试源文件已给出</p>
</li>
</ol>
<h2 id="发送系统通知"><a href="#发送系统通知" class="headerlink" title="发送系统通知"></a>发送系统通知</h2><ul>
<li>触发事件<ul>
<li>评论后，发布通知</li>
<li>点赞后，发布通知</li>
<li>关注后，发布通知</li>
</ul>
</li>
<li>处理事件<ul>
<li>封装事件对象</li>
<li>开发事件的生产者</li>
<li>开发事件的消费者</li>
</ul>
</li>
</ul>
<h3 id="开发原理"><a href="#开发原理" class="headerlink" title="开发原理"></a>开发原理</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223102514.png" srcset="/img/loading.gif" alt="原理"></p>
<h3 id="开发流程-12"><a href="#开发流程-12" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>创建事件对象</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Event</span> </span>&#123;
     <span class="hljs-comment">// return this的原因是让其可以链式编程</span>
    <span class="hljs-keyword">private</span> String topic;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> userId;
    <span class="hljs-comment">// type为1 id为帖子id type为2 id为评论表当前回复的id</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> entityType;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> entityId;
    <span class="hljs-comment">// 发布帖子/发表评论的人</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> entityUserId;
    <span class="hljs-comment">// 拓展其他业务</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getTopic</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> topic;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Event <span class="hljs-title">setTopic</span><span class="hljs-params">(String topic)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.topic = topic;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getUserId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Event <span class="hljs-title">setUserId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.userId = userId;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getEntityType</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> entityType;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Event <span class="hljs-title">setEntityType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityType)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.entityType = entityType;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getEntityId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> entityId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Event <span class="hljs-title">setEntityId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.entityId = entityId;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getEntityUserId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> entityUserId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Event <span class="hljs-title">setEntityUserId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> entityUserId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.entityUserId = entityUserId;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">getData</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> data;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Event <span class="hljs-title">setData</span><span class="hljs-params">(String key, Object value)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.data.put(key, value);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>业务层角度创建事件生产者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventProducer</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate kafkaTemplate;

    <span class="hljs-comment">// 处理事件</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fireEvent</span><span class="hljs-params">(Event event)</span></span>&#123;
        <span class="hljs-comment">// 将事件发送指定主题</span>
        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));
    &#125;
&#125;</code></pre></div>
</li>
<li><p>创建事件消费者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(EventConsumer.class);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MessageService messageService;

    <span class="hljs-meta">@KafkaListener(topics = &#123;TOPIC_COMMENT, TOPIC_LIKE, TOPIC_FOLLOW&#125;)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleEventMessage</span><span class="hljs-params">(ConsumerRecord record)</span></span>&#123;
        <span class="hljs-keyword">if</span> (record == <span class="hljs-keyword">null</span> || record.value() == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">// 空消息</span>
            logger.error(<span class="hljs-string">&quot;消息内容为空！&quot;</span>);
            <span class="hljs-keyword">return</span>;
        &#125;
        Event event = JSONObject.parseObject(record.value().toString(), Event.class);
        <span class="hljs-keyword">if</span> (event == <span class="hljs-keyword">null</span>)&#123;
            logger.error(<span class="hljs-string">&quot;消息格式为空！&quot;</span>);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">// 发送站内通知</span>
        Message message = <span class="hljs-keyword">new</span> Message();
        message.setFromId(SYSTEM_USERID);
        message.setToId(event.getEntityUserId());
        message.setConversationId(event.getTopic());
        message.setCreateTime(<span class="hljs-keyword">new</span> Date());

        Map&lt;String, Object&gt; content = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        content.put(<span class="hljs-string">&quot;userId&quot;</span>, event.getUserId());
        content.put(<span class="hljs-string">&quot;entityType&quot;</span>, event.getEntityType());
        content.put(<span class="hljs-string">&quot;entityId&quot;</span>, event.getEntityId());
        <span class="hljs-comment">// 额外date</span>
        <span class="hljs-keyword">if</span> (!event.getData().isEmpty())&#123;
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry:event.getData().entrySet())&#123;
                content.put(entry.getKey(), entry.getValue());
            &#125;
        &#125;
        message.setContent(JSONObject.toJSONString(content));

        messageService.insertLetter(message);

    &#125;
&#125;</code></pre></div>
</li>
<li><p>修改常量接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 主题:评论</span>
<span class="hljs-comment"> */</span>
String TOPIC_COMMENT = <span class="hljs-string">&quot;comment&quot;</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 主题:点赞</span>
<span class="hljs-comment"> */</span>
String TOPIC_LIKE = <span class="hljs-string">&quot;like&quot;</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 主题:关注</span>
<span class="hljs-comment"> */</span>
String TOPIC_FOLLOW = <span class="hljs-string">&quot;follow&quot;</span>;</code></pre></div>
</li>
<li><p>修改评论、点赞、关注Controller</p>
</li>
<li><p>评论事件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 触发评论事件</span>
<span class="hljs-comment">// type为1 id为帖子id</span>
<span class="hljs-comment">// type为2 id为评论的id</span>
Event event = <span class="hljs-keyword">new</span> Event()
        .setTopic(TOPIC_COMMENT)
        .setUserId(hostHolder.getUsers().getId())
        .setEntityType(comment.getEntityType())
        .setEntityId(comment.getEntityId())
        .setData(<span class="hljs-string">&quot;postId&quot;</span>, discussPostId);
<span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST)&#123;
    <span class="hljs-comment">// EntityUserId 存帖子作者id 给作者发消息</span>
    DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());
    event.setEntityUserId(target.getUserId());
&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_COMMENT)&#123;
    <span class="hljs-comment">// EntityUserId 存当前评论的id 给评论作者发消息</span>
    Comment target = commentService.findCommentById(comment.getEntityId());
    event.setEntityUserId(target.getUserId());
&#125;

eventProducer.fireEvent(event);</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223103720.png" srcset="/img/loading.gif" alt="评论事件"></p>
</li>
<li><p>点赞事件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 触发点赞事件</span>
<span class="hljs-keyword">if</span> (likeStatus == <span class="hljs-number">1</span>)&#123;
    Event event = <span class="hljs-keyword">new</span> Event()
            .setTopic(TOPIC_LIKE)
            .setUserId(user.getId())
            .setEntityType(entityType)
            .setEntityId(entityId)
            .setEntityUserId(entityUserId)
            .setData(<span class="hljs-string">&quot;postId&quot;</span>, postId);

    eventProducer.fireEvent(event);
&#125;</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223103905.png" srcset="/img/loading.gif" alt="点赞事件"></p>
</li>
<li><p>关注事件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 触发关注事件</span>
Event event = <span class="hljs-keyword">new</span> Event()
        .setTopic(TOPIC_FOLLOW)
        .setUserId(user.getId())
        .setEntityType(entityType)
        .setEntityId(entityId)
        .setEntityUserId(entityId);

eventProducer.fireEvent(event);</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223103952.png" srcset="/img/loading.gif" alt="image-20201223103949547"></p>
</li>
</ol>
<h3 id="开发流程图-7"><a href="#开发流程图-7" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223110623.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="显示系统消息"><a href="#显示系统消息" class="headerlink" title="显示系统消息"></a>显示系统消息</h2><ul>
<li>通知列表<ul>
<li>显示评论、点赞、关注三种类型通知</li>
</ul>
</li>
<li>通知详情<ul>
<li>分页显示某一类主题通知</li>
</ul>
</li>
<li>未读<ul>
<li>页面头部显示所有未读消息</li>
</ul>
</li>
</ul>
<h3 id="开发流程-13"><a href="#开发流程-13" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写MessageMapper和mapper.xml</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 查询某个主题下最新的通知</span>
<span class="hljs-function">Message <span class="hljs-title">selectLatestNotice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic)</span></span>;
<span class="hljs-comment">// 查询某个主题包含通知数量</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectNoticeCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic)</span></span>;
<span class="hljs-comment">// 查询未读通知数量</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">selectNoticeUnreadCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic)</span></span>;

<span class="hljs-comment">// 查询某个主题所有的通知</span>
<span class="hljs-function">List&lt;Message&gt; <span class="hljs-title">selectNotices</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>;</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectLatestNotice&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Message&quot;</span>&gt;</span>
    select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
    from message
    where id in (
    select max(id) from message
    where status != 2
    and from_id = 1
    and to_id = #&#123;userId&#125;
    and conversation_id = #&#123;topic&#125;
    )
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectNoticeCount&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span>
    select count(id) from message
    where status != 2
    and from_id = 1
    and to_id = #&#123;userId&#125;
    and conversation_id = #&#123;topic&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectNoticeUnreadCount&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span>
    select count(id) from message
    where status = 0
    and from_id = 1
    and to_id = #&#123;userId&#125;
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;topic!=null&quot;</span>&gt;</span>
        and conversation_id = #&#123;topic&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectNotices&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Message&quot;</span>&gt;</span>
    select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
    from message
    where status != 2
    and from_id = 1
    and to_id = #&#123;userId&#125;
    and conversation_id = #&#123;topic&#125;
    order by create_time desc
    limit #&#123;offset&#125;, #&#123;limit&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></code></pre></div>
</li>
<li><p>编写MessageService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">findLatestNotice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic)</span></span>&#123;
    <span class="hljs-keyword">return</span> messageMapper.selectLatestNotice(userId, topic);
&#125;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findNoticeCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic)</span></span>&#123;
    <span class="hljs-keyword">return</span> messageMapper.selectNoticeCount(userId, topic);
&#125;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findNoticeUnreadCount</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic)</span></span>&#123;
    <span class="hljs-keyword">return</span> messageMapper.selectNoticeUnreadCount(userId, topic);
&#125;

<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title">findNotices</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId, String topic, <span class="hljs-keyword">int</span> offset, <span class="hljs-keyword">int</span> limit)</span></span>&#123;
    <span class="hljs-keyword">return</span> messageMapper.selectNotices(userId, topic, offset, limit);
&#125;</code></pre></div>
</li>
<li><p>编写MessageController 显示消息主页</p>
<div class="hljs"><pre><code class="hljs java">    <span class="hljs-meta">@RequestMapping(path = &quot;/notice/list&quot;, method = RequestMethod.GET)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getNoticeList</span><span class="hljs-params">(Model model)</span></span>&#123;
        User user = hostHolder.getUsers();
        <span class="hljs-comment">// 查询评论类通知</span>
        Message message = messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);
        Map&lt;String, Object&gt; messageVo = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">if</span> (message != <span class="hljs-keyword">null</span>)&#123;
            messageVo.put(<span class="hljs-string">&quot;message&quot;</span>, message);
            String content = HtmlUtils.htmlUnescape(message.getContent());
            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);
            messageVo.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));
            messageVo.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));
            messageVo.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));
            messageVo.put(<span class="hljs-string">&quot;postId&quot;</span>, data.get(<span class="hljs-string">&quot;postid&quot;</span>));

            <span class="hljs-keyword">int</span> count = messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);
            messageVo.put(<span class="hljs-string">&quot;count&quot;</span>, count);

            <span class="hljs-keyword">int</span> unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);
            messageVo.put(<span class="hljs-string">&quot;unread&quot;</span>, unread);
        &#125;<span class="hljs-keyword">else</span> &#123;
            messageVo.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-keyword">null</span>);
        &#125;
        model.addAttribute(<span class="hljs-string">&quot;commentNotice&quot;</span>, messageVo);
        <span class="hljs-comment">// 查询点赞类通知</span>
        message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);
        messageVo = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">if</span> (message != <span class="hljs-keyword">null</span>)&#123;
            messageVo.put(<span class="hljs-string">&quot;message&quot;</span>, message);
            String content = HtmlUtils.htmlUnescape(message.getContent());
            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);
            messageVo.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));
            messageVo.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));
            messageVo.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));
            messageVo.put(<span class="hljs-string">&quot;postId&quot;</span>, data.get(<span class="hljs-string">&quot;postid&quot;</span>));

            <span class="hljs-keyword">int</span> count = messageService.findNoticeCount(user.getId(), TOPIC_LIKE);
            messageVo.put(<span class="hljs-string">&quot;count&quot;</span>, count);

            <span class="hljs-keyword">int</span> unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);
            messageVo.put(<span class="hljs-string">&quot;unread&quot;</span>, unread);
        &#125;<span class="hljs-keyword">else</span> &#123;
            messageVo.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-keyword">null</span>);
        &#125;
        model.addAttribute(<span class="hljs-string">&quot;likeNotice&quot;</span>, messageVo);
        <span class="hljs-comment">// 查询关注类通知</span>
        message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);
        messageVo = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">if</span> (message != <span class="hljs-keyword">null</span>)&#123;
            messageVo.put(<span class="hljs-string">&quot;message&quot;</span>, message);
            String content = HtmlUtils.htmlUnescape(message.getContent());
            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);
            messageVo.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));
            messageVo.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));
            messageVo.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));
<span class="hljs-comment">//            messageVo.put(&quot;postId&quot;, data.get(&quot;postid&quot;));</span>

            <span class="hljs-keyword">int</span> count = messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);
            messageVo.put(<span class="hljs-string">&quot;count&quot;</span>, count);

            <span class="hljs-keyword">int</span> unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);
            messageVo.put(<span class="hljs-string">&quot;unread&quot;</span>, unread);
        &#125;<span class="hljs-keyword">else</span> &#123;
            messageVo.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-keyword">null</span>);
        &#125;
        model.addAttribute(<span class="hljs-string">&quot;followNotice&quot;</span>, messageVo);
        <span class="hljs-comment">// 查询未读消息数量</span>
        <span class="hljs-keyword">int</span> letterUnreadCount = messageService.findeLetterUnreadCount(user.getId(), <span class="hljs-keyword">null</span>);
        <span class="hljs-keyword">int</span> noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), <span class="hljs-keyword">null</span>);
        model.addAttribute(<span class="hljs-string">&quot;letterUnreadCount&quot;</span>, letterUnreadCount);
        model.addAttribute(<span class="hljs-string">&quot;noticeUnreadCount&quot;</span>, noticeUnreadCount);

        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/notice&quot;</span>;
    &#125;</code></pre></div>
</li>
<li><p>编写MessageController 显示具体消息的全部页面</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/notice/detail/&#123;topic&#125;&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getNoticeDetail</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;topic&quot;)</span>String topic,Page page, Model model)</span></span>&#123;
    User user = hostHolder.getUsers();

    page.setLimit(<span class="hljs-number">5</span>);
    page.setRows(messageService.findNoticeCount(user.getId(), topic));
    page.setPath(<span class="hljs-string">&quot;/message/notice/detail/&quot;</span>+topic);

    List&lt;Message&gt; noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String, Object&gt;&gt; noticeVoList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">if</span> (noticeList!=<span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">for</span> (Message notice: noticeList) &#123;
            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
            <span class="hljs-comment">// 通知</span>
            map.put(<span class="hljs-string">&quot;notice&quot;</span>, notice);
            <span class="hljs-comment">// 内容</span>
            String content = HtmlUtils.htmlUnescape(notice.getContent());
            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);
            map.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));
            map.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));
            map.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));
            map.put(<span class="hljs-string">&quot;postId&quot;</span>, data.get(<span class="hljs-string">&quot;postId&quot;</span>));
            map.put(<span class="hljs-string">&quot;fromUser&quot;</span>, userService.findUserById(notice.getFromId()));
            noticeVoList.add(map);
        &#125;
    &#125;
    model.addAttribute(<span class="hljs-string">&quot;notices&quot;</span>, noticeVoList);

    <span class="hljs-comment">// 设置已读</span>
    List&lt;Integer&gt; ids = getMessageIds(noticeList);
    <span class="hljs-keyword">if</span> (!ids.isEmpty())&#123;
        messageService.readMessage(ids);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/notice-detail&quot;</span>;
&#125;</code></pre></div>
</li>
<li><p>编写拦截器记录全局消息未读数</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageUnreadInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HostHolder hostHolder;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MessageService messageService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        User user = hostHolder.getUsers();
        <span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span> &amp;&amp; modelAndView!=<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">int</span> letterUnreadCount = messageService.findeLetterUnreadCount(user.getId(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">int</span> noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), <span class="hljs-keyword">null</span>);
            modelAndView.addObject(<span class="hljs-string">&quot;unread&quot;</span>, letterUnreadCount + noticeUnreadCount);
        &#125;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>添加至WebMvcConfig</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> MessageUnreadInterceptor messageUnreadInterceptor;

    registry.addInterceptor(messageUnreadInterceptor)
            .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);

&#125;</code></pre></div>
</li>
<li><p>修改模版引擎（查看源文件）</p>
</li>
</ol>
<h3 id="开发流程图-8"><a href="#开发流程图-8" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223111729.png" srcset="/img/loading.gif" alt="流程图"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223112157.png" srcset="/img/loading.gif" alt="拦截器"></p>
<h1 id="ES与Security模块"><a href="#ES与Security模块" class="headerlink" title="ES与Security模块"></a>ES与Security模块</h1><h2 id="Spring-整合-Elastic-Search"><a href="#Spring-整合-Elastic-Search" class="headerlink" title="Spring 整合 Elastic Search"></a>Spring 整合 Elastic Search</h2><ul>
<li>引入依赖<ul>
<li>spirng-boot-starter-data-elastcsearch</li>
</ul>
</li>
<li>配置Elasticsearch<ul>
<li>cluster-name、cluster-nodes</li>
</ul>
</li>
<li>Spring Data Elasticsearch<ul>
<li>ElasticsearchTemplate</li>
<li>ElasticsearchRepository</li>
</ul>
</li>
</ul>
<p>注意：Elasticsearch版本与Spring Boot版本必须严格遵循统一</p>
<p>本项目使用elasticsearch 6.4.3</p>
<h3 id="开发流程-14"><a href="#开发流程-14" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>Maven依赖</p>
<div class="hljs"><pre><code class="hljs java">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre></div>
</li>
<li><p>配置es</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment"># ElasticSearchProperties</span>
<span class="hljs-meta">spring.data.elasticsearch.cluster-name</span>=<span class="hljs-string">nowcoder</span>
<span class="hljs-meta">spring.data.elasticsearch.cluster-nodes</span>=<span class="hljs-string">127.0.0.1:9300</span></code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223113939.png" srcset="/img/loading.gif" alt="配置本地"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223114002.png" srcset="/img/loading.gif" alt="与上面一致"></p>
</li>
</ol>
<ol start="3">
<li><p>解决es和redis同时占用netty问题</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommunityApplication</span> </span>&#123;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">// 解决redis和es同时使用NettyRuntime启动冲突问题</span>
        <span class="hljs-comment">// Netty4Utils setAvailableProcessors</span>
        System.setProperty(<span class="hljs-string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(CommunityApplication.class, args);
    &#125;

&#125;</code></pre></div>
</li>
<li><p>配置表对象和es存储对应的索引关系</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@Document(indexName = &quot;discusspost&quot;, type =&quot;_doc&quot;, shards = 6, replicas = 3)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscussPost</span> </span>&#123;

    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;

    <span class="hljs-meta">@Field(type = FieldType.Integer)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> userId;

    <span class="hljs-comment">// 往es存 互联网校招 analyzer把搜索的内容进行拆解最多单词 进行搜索匹配</span>
    <span class="hljs-comment">// searchAnalyzer 把搜索条目拆解最少单词, searchAnalyzer = &quot;ik_smart&quot;</span>
    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span>
    <span class="hljs-keyword">private</span> String title;

    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span>
    <span class="hljs-keyword">private</span> String content;

    <span class="hljs-meta">@Field(type = FieldType.Integer)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> type;

    <span class="hljs-meta">@Field(type = FieldType.Integer)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> status;

    <span class="hljs-meta">@Field(type = FieldType.Date)</span>
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-meta">@Field(type = FieldType.Integer)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> commentCount;

    <span class="hljs-meta">@Field(type = FieldType.Double)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> score;

&#125;</code></pre></div>

<p>其中es的ik插件请前往github下载对应版本 <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">ik</a></p>
</li>
<li><p>编写接口文件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span>
<span class="hljs-comment">// 声明主键类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DiscussPostRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ElasticsearchRepository</span>&lt;<span class="hljs-title">DiscussPost</span>, <span class="hljs-title">Integer</span>&gt; </span>&#123;

&#125;</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223114530.png" srcset="/img/loading.gif" alt="es"></p>
</li>
<li><p>编写测试类（源文件给出）</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223114717.png" srcset="/img/loading.gif" alt="测试类"></p>
</li>
</ol>
<h2 id="搜索功能"><a href="#搜索功能" class="headerlink" title="搜索功能"></a>搜索功能</h2><ul>
<li>搜索服务<ul>
<li>将帖子保存至Elasticsearch服务器。</li>
<li>从Elasticsearch服务器删除帖子。</li>
<li>从Elasticsearch服务器搜索帖子。</li>
</ul>
</li>
<li>发布事件<ul>
<li>发布帖子时，将帖子异步的提交到Elasticsearch服务器。</li>
<li>增加评论时，将帖子异步的提交到Elasticsearch服务器。</li>
<li>在消费组件中增加一个方法，消费帖子发布事件。</li>
</ul>
</li>
<li>显示结果<ul>
<li>在控制器中处理搜索请求，在HTML上显示搜索结果。</li>
</ul>
</li>
</ul>
<h3 id="开发流程-15"><a href="#开发流程-15" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写ElasticsearchService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ElasticSearchService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscussPostRepository discussPostRepository;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticsearchTemplate elasticTemplate;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveDiscussPost</span><span class="hljs-params">(DiscussPost discussPost)</span></span>&#123;
        discussPostRepository.save(discussPost);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteDiscussPost</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;
        discussPostRepository.deleteById(id);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Page&lt;DiscussPost&gt; <span class="hljs-title">searchDiscussPost</span><span class="hljs-params">(String keywords, <span class="hljs-keyword">int</span> current, <span class="hljs-keyword">int</span> limit)</span></span>&#123;
        SearchQuery searchQuery = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder()
                .withQuery(QueryBuilders.multiMatchQuery(keywords, <span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>))
                .withSort(SortBuilders.fieldSort(<span class="hljs-string">&quot;type&quot;</span>).order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort(<span class="hljs-string">&quot;score&quot;</span>).order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort(<span class="hljs-string">&quot;createTime&quot;</span>).order(SortOrder.DESC))
                .withPageable(PageRequest.of(current, limit))
                .withHighlightFields(
                        <span class="hljs-keyword">new</span> HighlightBuilder.Field(<span class="hljs-string">&quot;title&quot;</span>).preTags(<span class="hljs-string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="hljs-string">&quot;&lt;/em&gt;&quot;</span>),
                        <span class="hljs-keyword">new</span> HighlightBuilder.Field(<span class="hljs-string">&quot;content&quot;</span>).preTags(<span class="hljs-string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="hljs-string">&quot;&lt;/em&gt;&quot;</span>)
                ).build();

        <span class="hljs-keyword">return</span> elasticTemplate.queryForPage(searchQuery, DiscussPost.class, <span class="hljs-keyword">new</span> SearchResultMapper() &#123;
           
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">AggregatedPage&lt;T&gt; <span class="hljs-title">mapResults</span><span class="hljs-params">(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable)</span> </span>&#123;
                SearchHits hits = response.getHits();
                <span class="hljs-keyword">if</span> (hits.getTotalHits() &lt;= <span class="hljs-number">0</span>) &#123;
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
                &#125;

                List&lt;DiscussPost&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
                <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;
                    DiscussPost post = <span class="hljs-keyword">new</span> DiscussPost();

                    String id = hit.getSourceAsMap().get(<span class="hljs-string">&quot;id&quot;</span>).toString();
                    post.setId(Integer.valueOf(id));

                    String userId = hit.getSourceAsMap().get(<span class="hljs-string">&quot;userId&quot;</span>).toString();
                    post.setUserId(Integer.valueOf(userId));

                    String title = hit.getSourceAsMap().get(<span class="hljs-string">&quot;title&quot;</span>).toString();
                    post.setTitle(title);

                    String content = hit.getSourceAsMap().get(<span class="hljs-string">&quot;content&quot;</span>).toString();
                    post.setContent(content);

                    String status = hit.getSourceAsMap().get(<span class="hljs-string">&quot;status&quot;</span>).toString();
                    post.setStatus(Integer.valueOf(status));

                    String createTime = hit.getSourceAsMap().get(<span class="hljs-string">&quot;createTime&quot;</span>).toString();
                    post.setCreateTime(<span class="hljs-keyword">new</span> Date(Long.valueOf(createTime)));

                    String commentCount = hit.getSourceAsMap().get(<span class="hljs-string">&quot;commentCount&quot;</span>).toString();
                    post.setCommentCount(Integer.valueOf(commentCount));

                    <span class="hljs-comment">// 处理高亮显示的结果</span>
                    HighlightField titleField = hit.getHighlightFields().get(<span class="hljs-string">&quot;title&quot;</span>);
                    <span class="hljs-keyword">if</span> (titleField != <span class="hljs-keyword">null</span>) &#123;
                        post.setTitle(titleField.getFragments()[<span class="hljs-number">0</span>].toString());
                    &#125;

                    HighlightField contentField = hit.getHighlightFields().get(<span class="hljs-string">&quot;content&quot;</span>);
                    <span class="hljs-keyword">if</span> (contentField != <span class="hljs-keyword">null</span>) &#123;
                        post.setContent(contentField.getFragments()[<span class="hljs-number">0</span>].toString());
                    &#125;

                    list.add(post);
                &#125;

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AggregatedPageImpl(list, pageable,
                        hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore());
            &#125;

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">mapSearchHit</span><span class="hljs-params">(SearchHit searchHit, Class&lt;T&gt; aClass)</span> </span>&#123;
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            &#125;

        &#125;);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>处理发帖事件</p>
<p>常量接口添加：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 主题:发帖</span>
<span class="hljs-comment"> */</span>
String TOPIC_PUBLISH = <span class="hljs-string">&quot;publish&quot;</span>;</code></pre></div>
</li>
<li><p>处理事件消费者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@KafkaListener(topics = TOPIC_PUBLISH)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleEventPublish</span><span class="hljs-params">(ConsumerRecord record)</span></span>&#123;
    <span class="hljs-keyword">if</span> (record == <span class="hljs-keyword">null</span> || record.value() == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-comment">// 空消息</span>
        logger.error(<span class="hljs-string">&quot;消息内容为空！&quot;</span>);
        <span class="hljs-keyword">return</span>;
    &#125;
    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    <span class="hljs-keyword">if</span> (event == <span class="hljs-keyword">null</span>)&#123;
        logger.error(<span class="hljs-string">&quot;消息格式为空！&quot;</span>);
        <span class="hljs-keyword">return</span>;
    &#125;

    DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId());
    elasticSearchService.saveDiscussPost(post);

&#125;
</code></pre></div>
</li>
<li><p>DiscusspostController处理发帖事件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 触发发帖事件</span>
Event event = <span class="hljs-keyword">new</span> Event()
        .setTopic(TOPIC_PUBLISH)
        .setUserId(user.getId())
        .setEntityType(ENTITY_TYPE_POST)
        .setEntityId(discussPost.getId());
eventProducer.fireEvent(event);</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223140158.png" srcset="/img/loading.gif" alt="发帖事件"></p>
</li>
<li><p>CommentController 处理发帖事件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST)&#123;
    <span class="hljs-comment">// 触发发帖事件</span>
    event = <span class="hljs-keyword">new</span> Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(comment.getUserId())
            .setEntityType(ENTITY_TYPE_POST)
            <span class="hljs-comment">// 更新的是帖子</span>
            .setEntityId(discussPostId);
    eventProducer.fireEvent(event);
&#125;</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223140313.png" srcset="/img/loading.gif" alt="发帖事件"></p>
</li>
<li><p>编写SearchController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticSearchService elasticSearchService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LikeService likeService;

    <span class="hljs-comment">//    /serach?keywords=</span>
    <span class="hljs-meta">@RequestMapping(path = &quot;/search&quot;, method = RequestMethod.GET)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">search</span><span class="hljs-params">(String keywords, Page page, Model model)</span></span>&#123;
        org.springframework.data.domain.Page&lt;DiscussPost&gt; discussPosts
                = elasticSearchService.searchDiscussPost(keywords, page.getCurrent() - <span class="hljs-number">1</span>, page.getLimit());
        List&lt;Map&lt;String, Object&gt;&gt; discussposts = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (DiscussPost post: discussPosts
             ) &#123;
            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
            <span class="hljs-comment">// 帖子</span>
            map.put(<span class="hljs-string">&quot;post&quot;</span>, post);
            <span class="hljs-comment">// 作者</span>
            map.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById(post.getUserId()));
            <span class="hljs-comment">// 点赞</span>
            map.put(<span class="hljs-string">&quot;likeCount&quot;</span>, likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId()));
            discussposts.add(map);
        &#125;
        <span class="hljs-comment">// 分页信息</span>
        page.setPath(<span class="hljs-string">&quot;/search?keywords=&quot;</span>+keywords);
        page.setRows(discussPosts == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : (<span class="hljs-keyword">int</span>) discussPosts.getTotalElements());

        model.addAttribute(<span class="hljs-string">&quot;discussPosts&quot;</span>, discussposts);
        model.addAttribute(<span class="hljs-string">&quot;keywords&quot;</span>, keywords);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/search&quot;</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>处理模版引擎</p>
</li>
</ol>
<h3 id="开发流程图-9"><a href="#开发流程图-9" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223142518.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="Spring-Security-权限管理"><a href="#Spring-Security-权限管理" class="headerlink" title="Spring Security 权限管理"></a>Spring Security 权限管理</h2><h3 id="Spring-Security原理大概"><a href="#Spring-Security原理大概" class="headerlink" title="Spring Security原理大概"></a>Spring Security原理大概</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223143326.png" srcset="/img/loading.gif" alt="原理"></p>
<ul>
<li>登录检查<ul>
<li>之前采用拦截器实现了登录检查,这是简单的权限管理方案,现在将其废弃。</li>
</ul>
</li>
<li>授权配置<ul>
<li>对当前系统内包含的所有的请求，分配访问权限(普通用户、版主、管理员)。</li>
</ul>
</li>
<li>认证方案<ul>
<li>绕过Security认证流程, 采用系统原来的认证方案。</li>
</ul>
</li>
<li>CSRF配置<ul>
<li>防止CSRF攻击的基本原理，以及表单、AJAX相关的配置。</li>
</ul>
</li>
</ul>
<blockquote>
<p>Spring Security 写的我差点脑溢血</p>
</blockquote>
<h3 id="开发流程-16"><a href="#开发流程-16" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>Maven引入</p>
<div class="hljs"><pre><code class="hljs java">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre></div>
</li>
<li><p>废弃之前的LoginRequired注解</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223143832.png" srcset="/img/loading.gif" alt="废弃"></p>
</li>
</ol>
<ol start="3">
<li><p>常量接口增加权限常量</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 普通用户</span>
<span class="hljs-comment"> */</span>
String AUTHORITY_USER = <span class="hljs-string">&quot;user&quot;</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 管理员(删除)</span>
<span class="hljs-comment"> */</span>
String AUTHORITY_ADMIN = <span class="hljs-string">&quot;admin&quot;</span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 版主(置顶、加精)</span>
<span class="hljs-comment"> */</span>
String AUTHORITY_MODERATOR = <span class="hljs-string">&quot;moderator&quot;</span>;</code></pre></div>
</li>
<li><p>SecurityConfig配置</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> </span>&#123;
        web.ignoring().antMatchers(<span class="hljs-string">&quot;/resources/**&quot;</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        http.authorizeRequests()
                .antMatchers(
                      <span class="hljs-string">&quot;/user/setting&quot;</span>,<span class="hljs-string">&quot;/user/upload&quot;</span>,<span class="hljs-string">&quot;/user/updatePassword&quot;</span>,<span class="hljs-string">&quot;/user/mypost&quot;</span>,<span class="hljs-string">&quot;/user/myreply&quot;</span>,
                        <span class="hljs-string">&quot;/discuss/add&quot;</span>, <span class="hljs-string">&quot;/comment/add/**&quot;</span>, <span class="hljs-string">&quot;/message/**&quot;</span>,
                        <span class="hljs-string">&quot;/like&quot;</span>, <span class="hljs-string">&quot;/follow&quot;</span>, <span class="hljs-string">&quot;/unfollow&quot;</span>
                )
                .hasAnyAuthority(
                        AUTHORITY_USER, AUTHORITY_MODERATOR, AUTHORITY_ADMIN
                )
                .antMatchers(
                        <span class="hljs-string">&quot;/discuss/top&quot;</span>,
                        <span class="hljs-string">&quot;/discuss/wonderful&quot;</span>
                )
                .hasAnyAuthority(
                        AUTHORITY_MODERATOR
                )
                .antMatchers(
                        <span class="hljs-string">&quot;/data/**&quot;</span>,
                        <span class="hljs-string">&quot;/discuss/delete&quot;</span>,
                        <span class="hljs-string">&quot;/actuator/**&quot;</span>
                )
                .hasAnyAuthority(
                        AUTHORITY_ADMIN
                )
                .anyRequest().permitAll()
                .and().csrf().disable();

        <span class="hljs-comment">// 权限冲突处理 普通请求(返回html)和异步请求(返回json)</span>
        http.exceptionHandling()
                <span class="hljs-comment">// 未登录处理</span>
                .authenticationEntryPoint(<span class="hljs-keyword">new</span> AuthenticationEntryPoint() &#123;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;
                        <span class="hljs-comment">// 分普通和异步请求</span>
                        String xRequestedWith = request.getHeader(<span class="hljs-string">&quot;x-requested-with&quot;</span>);
                        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith))&#123;
                            <span class="hljs-comment">// 异步请求</span>
                            response.setContentType(<span class="hljs-string">&quot;application/plain;charset=utf-8&quot;</span>);
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJSONString(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;用户未登录!&quot;</span>));
                        &#125;<span class="hljs-keyword">else</span> &#123;
                            response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/login&quot;</span>);
                        &#125;
                    &#125;
                &#125;)
                <span class="hljs-comment">// 登录处理</span>
                .accessDeniedHandler(<span class="hljs-keyword">new</span> AccessDeniedHandler() &#123;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;
                        <span class="hljs-comment">// 分普通和异步请求</span>
                        String xRequestedWith = request.getHeader(<span class="hljs-string">&quot;x-requested-with&quot;</span>);
                        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith))&#123;
                            <span class="hljs-comment">// 异步请求</span>
                            response.setContentType(<span class="hljs-string">&quot;application/plain;charset=utf-8&quot;</span>);
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJSONString(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;用户权限不足&quot;</span>));
                        &#125;<span class="hljs-keyword">else</span> &#123;
                            response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/denied&quot;</span>);
                        &#125;
                    &#125;
                &#125;);
        <span class="hljs-comment">// SpringSecurity底层默认拦截/logout请求,并运行其logout逻辑</span>
        <span class="hljs-comment">// SpringSecurity为Filter filter在controller之前</span>
        <span class="hljs-comment">// 想要运行自己的/logout 覆盖其默认逻辑 欺骗</span>
        http.logout().logoutUrl(<span class="hljs-string">&quot;/securitylogout&quot;</span>);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>UserService权限配置</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities(<span class="hljs-keyword">int</span> userId) &#123;
    User user = userMapper.selectById(userId);
    List&lt;GrantedAuthority&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    list.add(<span class="hljs-keyword">new</span> GrantedAuthority() &#123;
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAuthority</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">switch</span> (user.getType()) &#123;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">return</span> AUTHORITY_ADMIN;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">return</span> AUTHORITY_MODERATOR;
                    <span class="hljs-keyword">default</span>:
                        <span class="hljs-keyword">return</span> AUTHORITY_USER;
            &#125;
        &#125;
    &#125;);
    <span class="hljs-keyword">return</span> list;
&#125;</code></pre></div>
</li>
<li><p>拦截器预判断用户权限</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

    <span class="hljs-comment">// 从cookie中获取ticket</span>
    String ticket = CookieUtil.getValue(request, <span class="hljs-string">&quot;ticket&quot;</span>);

    <span class="hljs-keyword">if</span> (ticket != <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-comment">// 查询</span>
        LoginTicket loginTicket = userService.findLoginTicket(ticket);
        <span class="hljs-comment">// 检测有效</span>
        <span class="hljs-keyword">if</span> (loginTicket != <span class="hljs-keyword">null</span> &amp;&amp; loginTicket.getStatus() == <span class="hljs-number">0</span> &amp;&amp; loginTicket.getExpired().after(<span class="hljs-keyword">new</span> Date()))&#123;
            <span class="hljs-comment">// 根据凭证找到用户</span>
            User user = userService.findUserById(loginTicket.getUserId());
            <span class="hljs-comment">// 在本次请求中持有用户</span>
            hostHolder.setUsers(user);
            <span class="hljs-comment">// 构建用户认证结果 存入SecurityContext 以便与security进行授权(越过了security认证 用了自己的认证 需要自己授权)</span>
            Authentication authentication = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(
                    user, user.getPassword(), userService.getAuthorities(user.getId())
            );
            SecurityContextHolder.setContext(<span class="hljs-keyword">new</span> SecurityContextImpl(authentication));
        &#125;
    &#125;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
&#125;</code></pre></div>

<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223144555.png" srcset="/img/loading.gif" alt="退出功能"></p>
</li>
</ol>
<h2 id="置顶、加精、删除"><a href="#置顶、加精、删除" class="headerlink" title="置顶、加精、删除"></a>置顶、加精、删除</h2><ul>
<li>功能实现<ul>
<li>点击置顶，修改帖子的类型。</li>
<li>点击“加精”、“删除”， 修改帖子的状态。</li>
</ul>
</li>
<li>权限管理<ul>
<li>版主可以执行“置顶”</li>
<li>管理员可以执行“删除”操作。</li>
</ul>
</li>
<li>按钮显示<ul>
<li>版主可以看到“置顶”</li>
<li>管理员可以看到“删除”按钮。</li>
</ul>
</li>
</ul>
<h3 id="开发流程-17"><a href="#开发流程-17" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>Maven导入</p>
<div class="hljs"><pre><code class="hljs java">&lt;dependency&gt;
    &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
    &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
    &lt;version&gt;3.0.4.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code></pre></div>
</li>
<li><p>便DiscusspostMapper 和 mapper文件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">int</span> type)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateStatus</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">int</span> status)</span></span>;</code></pre></div>

<div class="hljs"><pre><code class="hljs java">&lt;update id=<span class="hljs-string">&quot;updateType&quot;</span>&gt;
    update discuss_post set type = #&#123;type&#125;
    where id = #&#123;id&#125;
&lt;/update&gt;

&lt;update id=<span class="hljs-string">&quot;updateStatus&quot;</span>&gt;
    update discuss_post set status = #&#123;status&#125;
    where id = #&#123;id&#125;
&lt;/update&gt;</code></pre></div>
</li>
<li><p>编写DiscusspostService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">int</span> type)</span></span>&#123;
    <span class="hljs-keyword">return</span> discussPostMapper.updateType(id, type);
&#125;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateStatus</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">int</span> status)</span></span>&#123;
    <span class="hljs-keyword">return</span> discussPostMapper.updateStatus(id, status);
&#125;</code></pre></div>
</li>
<li><p>编写DiscusspostController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">// 置顶</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/top&quot;, method = RequestMethod.POST)</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setTop</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;
    discussPostService.updateType(id, <span class="hljs-number">1</span>);

    <span class="hljs-comment">// 触发发帖事件 ES更新</span>
    Event event = <span class="hljs-keyword">new</span> Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(hostHolder.getUsers().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);

    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;置顶成功！&quot;</span>);

&#125;

<span class="hljs-comment">// 加精</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/wonderful&quot;, method = RequestMethod.POST)</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setWonderful</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;
    discussPostService.updateStatus(id, <span class="hljs-number">1</span>);

    <span class="hljs-comment">// 触发发帖事件 ES更新</span>
    Event event = <span class="hljs-keyword">new</span> Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(hostHolder.getUsers().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);
&#125;

<span class="hljs-comment">// 删除</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/delete&quot;, method = RequestMethod.POST)</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setDelete</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;
    discussPostService.updateStatus(id, <span class="hljs-number">2</span>);
    <span class="hljs-comment">// ES删除帖 触发删帖事件</span>
    Event event = <span class="hljs-keyword">new</span> Event()
            .setTopic(TOPIC_DELETE)
            .setUserId(hostHolder.getUsers().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);
    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;删除成功！&quot;</span>);
&#125;</code></pre></div>
</li>
<li><p>编写js</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// 置顶</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTop</span>(<span class="hljs-params"></span>) </span>&#123;
    $.post(
        CONTEXT_PATH + <span class="hljs-string">&quot;/discuss/top&quot;</span>,
        &#123;<span class="hljs-string">&quot;id&quot;</span>:$(<span class="hljs-string">&quot;#postId&quot;</span>).val()&#125;,
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            data = $.parseJSON(data);
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
                $(<span class="hljs-string">&quot;#topBtn&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-string">&quot;disabled&quot;</span>);
            &#125; <span class="hljs-keyword">else</span> &#123;
                alert(data.msg);
            &#125;
        &#125;
    );
&#125;

<span class="hljs-comment">// 加精</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setWonderful</span>(<span class="hljs-params"></span>) </span>&#123;
    $.post(
        CONTEXT_PATH + <span class="hljs-string">&quot;/discuss/wonderful&quot;</span>,
        &#123;<span class="hljs-string">&quot;id&quot;</span>:$(<span class="hljs-string">&quot;#postId&quot;</span>).val()&#125;,
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            data = $.parseJSON(data);
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
                $(<span class="hljs-string">&quot;#wonderfulBtn&quot;</span>).attr(<span class="hljs-string">&quot;disabled&quot;</span>, <span class="hljs-string">&quot;disabled&quot;</span>);
            &#125; <span class="hljs-keyword">else</span> &#123;
                alert(data.msg);
            &#125;
        &#125;
    );
&#125;

<span class="hljs-comment">// 删除</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDelete</span>(<span class="hljs-params"></span>) </span>&#123;
    $.post(
        CONTEXT_PATH + <span class="hljs-string">&quot;/discuss/delete&quot;</span>,
        &#123;<span class="hljs-string">&quot;id&quot;</span>:$(<span class="hljs-string">&quot;#postId&quot;</span>).val()&#125;,
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            data = $.parseJSON(data);
            <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
                location.href = CONTEXT_PATH + <span class="hljs-string">&quot;/index&quot;</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                alert(data.msg);
            &#125;
        &#125;
    );
&#125;</code></pre></div>
</li>
<li><p>修改模版引擎</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223145804.png" srcset="/img/loading.gif" alt="权限"></p>
</li>
<li><p>SecurityConfig配置权限 源码已给出</p>
</li>
</ol>
<h3 id="开发流程图-10"><a href="#开发流程图-10" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223150722.png" srcset="/img/loading.gif" alt="流程图"></p>
<h1 id="额外功能丰富模块"><a href="#额外功能丰富模块" class="headerlink" title="额外功能丰富模块"></a>额外功能丰富模块</h1><h2 id="网站数据统计"><a href="#网站数据统计" class="headerlink" title="网站数据统计"></a>网站数据统计</h2><ul>
<li>UV (Unique Visitor)<ul>
<li>独立访客，需通过用户IP排重统计数据。</li>
<li>每次访问都要进行统计。</li>
<li>HyperLogLog，性能好，且存储空间小。</li>
</ul>
</li>
<li>DAU (Daily Active User)<ul>
<li>日活跃用户，需通过用户ID排重统计数据。访问过一次， 则认为其活跃。</li>
<li>Bitmap,性能好、且可以统计精确的结果</li>
</ul>
</li>
</ul>
<h3 id="开发流程-18"><a href="#开发流程-18" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>编写RedisKeyUtil</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_UV = <span class="hljs-string">&quot;uv&quot;</span>;
   
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_DAU = <span class="hljs-string">&quot;dau&quot;</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUVkey</span><span class="hljs-params">(String date)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_UV + SPILIT + date;
&#125;
   
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUVkey</span><span class="hljs-params">(String startDate, String endDate)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_UV + SPILIT + startDate + SPILIT + endDate;
&#125;
   
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getDAUkey</span><span class="hljs-params">(String date)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_DAU + SPILIT + date;
&#125;
   
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getDAUkey</span><span class="hljs-params">(String startDate, String endDate)</span></span>&#123;
    <span class="hljs-keyword">return</span> PREFIX_DAU + SPILIT + startDate + SPILIT + endDate;
&#125;</code></pre></div>

<p>看一天/多天的</p>
</li>
<li><p>编写DataService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

    <span class="hljs-keyword">private</span> SimpleDateFormat df = <span class="hljs-keyword">new</span> SimpleDateFormat(<span class="hljs-string">&quot;yyyyMMdd&quot;</span>);

    <span class="hljs-comment">// 将ip存入UV</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">recordUV</span><span class="hljs-params">(String ip)</span></span>&#123;
        String redisKey = RedisKeyUtil.getUVkey(df.format(<span class="hljs-keyword">new</span> Date()));
        redisTemplate.opsForHyperLogLog().add(redisKey, ip);
    &#125;

    <span class="hljs-comment">// 统计UV</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">calculateUV</span><span class="hljs-params">(Date start, Date end)</span></span>&#123;
        <span class="hljs-keyword">if</span> (start == <span class="hljs-keyword">null</span> || end == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数异常&quot;</span>);
        &#125;

        String redisKey = RedisKeyUtil.getUVkey(df.format(start), df.format(end));
        List&lt;String&gt; keys = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        Calendar calendar = Calendar.getInstance();
        calendar.setTime(start);
        <span class="hljs-keyword">while</span> (!calendar.getTime().after(end))&#123;
            String key = RedisKeyUtil.getUVkey(df.format(calendar.getTime()));
            keys.add(key);
            calendar.add(Calendar.DATE, <span class="hljs-number">1</span>);
        &#125;
        redisTemplate.opsForHyperLogLog().union(redisKey, keys.toArray());

        <span class="hljs-keyword">return</span> redisTemplate.opsForHyperLogLog().size(redisKey);
    &#125;

    <span class="hljs-comment">// 将指定用户计入DAU</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">recordDAU</span><span class="hljs-params">(<span class="hljs-keyword">int</span> userId)</span></span>&#123;
        String redisKey = RedisKeyUtil.getDAUkey(df.format(<span class="hljs-keyword">new</span> Date()));
        redisTemplate.opsForValue().setBit(redisKey, userId, <span class="hljs-keyword">true</span>);
    &#125;

    <span class="hljs-comment">// 统计DAU</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">calculateDAU</span><span class="hljs-params">(Date start, Date end)</span></span>&#123;
        <span class="hljs-keyword">if</span> (start == <span class="hljs-keyword">null</span> || end == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数异常&quot;</span>);
        &#125;

        String redisKey = RedisKeyUtil.getDAUkey(df.format(start), df.format(end));
        List&lt;<span class="hljs-keyword">byte</span>[]&gt; keys = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        Calendar calendar = Calendar.getInstance();
        calendar.setTime(start);
        <span class="hljs-keyword">while</span> (!calendar.getTime().after(end))&#123;
            String key = RedisKeyUtil.getDAUkey(df.format(calendar.getTime()));
            keys.add(key.getBytes());
            calendar.add(Calendar.DATE, <span class="hljs-number">1</span>);
        &#125;
        <span class="hljs-comment">// 进行OR运算</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">long</span>)redisTemplate.execute(<span class="hljs-keyword">new</span> RedisCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doInRedis</span><span class="hljs-params">(RedisConnection connection)</span> <span class="hljs-keyword">throws</span> DataAccessException </span>&#123;
                connection.bitOp(RedisStringCommands.BitOperation.OR,
                        redisKey.getBytes(), keys.toArray(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]));
                <span class="hljs-keyword">return</span> connection.bitCount(redisKey.getBytes());
            &#125;
        &#125;);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写data拦截器 统计并计入</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataService dataService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HostHolder hostHolder;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        <span class="hljs-comment">// 统计UV DAU</span>
        <span class="hljs-comment">// UV:ip</span>
        String ip = request.getRemoteHost();
        dataService.recordUV(ip);

        <span class="hljs-comment">// DAU:userId</span>
        User user = hostHolder.getUsers();
        <span class="hljs-keyword">if</span> (user!=<span class="hljs-keyword">null</span>)&#123;
            dataService.recordDAU(user.getId());
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;</code></pre></div>
</li>
<li><p>WebMvcConfig添加拦截器</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> DataInterceptor dataInterceptor;

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;
    registry.addInterceptor(dataInterceptor)
            .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);

&#125;</code></pre></div>
</li>
<li><p>编写DataController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataController</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataService dataService;

    <span class="hljs-comment">// 统计页面</span>
    <span class="hljs-meta">@RequestMapping(path = &quot;/data&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span>
    <span class="hljs-comment">// 后续用到转发 转发用的一个请求 后面为post</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getDataPage</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/admin/data&quot;</span>;
    &#125;

    <span class="hljs-comment">// 统计网站UV</span>
    <span class="hljs-meta">@RequestMapping(path = &quot;/data/uv&quot;, method = RequestMethod.POST)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUV</span><span class="hljs-params">(<span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date start,</span></span>
<span class="hljs-function"><span class="hljs-params">                        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date end, Model model)</span> </span>&#123;
        <span class="hljs-keyword">long</span> uv = dataService.calculateUV(start, end);
        model.addAttribute(<span class="hljs-string">&quot;uvResult&quot;</span>, uv);
        model.addAttribute(<span class="hljs-string">&quot;uvStartDate&quot;</span>, start);
        model.addAttribute(<span class="hljs-string">&quot;uvEndDate&quot;</span>, end);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;forward:/data&quot;</span>;
    &#125;

    <span class="hljs-comment">// 统计活跃用户</span>
    <span class="hljs-meta">@RequestMapping(path = &quot;/data/dau&quot;, method = RequestMethod.POST)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getDAU</span><span class="hljs-params">(<span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date start,</span></span>
<span class="hljs-function"><span class="hljs-params">                         <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date end, Model model)</span> </span>&#123;
        <span class="hljs-keyword">long</span> dau = dataService.calculateDAU(start, end);
        model.addAttribute(<span class="hljs-string">&quot;dauResult&quot;</span>, dau);
        model.addAttribute(<span class="hljs-string">&quot;dauStartDate&quot;</span>, start);
        model.addAttribute(<span class="hljs-string">&quot;dauEndDate&quot;</span>, end);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;forward:/data&quot;</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>处理模版引擎</p>
</li>
</ol>
<h3 id="开发流程图-11"><a href="#开发流程图-11" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223161822.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="热帖排行"><a href="#热帖排行" class="headerlink" title="热帖排行"></a>热帖排行</h2><ul>
<li>JDK线程池<ul>
<li>ExecutorService</li>
<li>ScheduledExecutorService</li>
</ul>
</li>
<li>Spring线程池<ul>
<li>ThreadPoolTaskExecutor</li>
<li>ThreadPoolTaskScheduler</li>
</ul>
</li>
<li>分布式定时任务<ul>
<li>Spring Quartz</li>
</ul>
</li>
</ul>
<p>JDK和Spring定时任务组件是基于内存的，配置参数基于内存，不同服务器内存不共享。</p>
<p>Quartz参数存到数据库，可以实现共享。</p>
<h3 id="Quartz原理"><a href="#Quartz原理" class="headerlink" title="Quartz原理"></a>Quartz原理</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223162549.png" srcset="/img/loading.gif" alt="原理图"></p>
<h3 id="Spring-整合-Quartz"><a href="#Spring-整合-Quartz" class="headerlink" title="Spring 整合 Quartz"></a>Spring 整合 Quartz</h3><ol>
<li><p>导入Quartz数据库</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223162756.png" srcset="/img/loading.gif" alt="Quartz_db"></p>
</li>
<li><p>Maven</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>配置</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment"># QuartzProperties</span>
<span class="hljs-meta">spring.quartz.job-store-type</span>=<span class="hljs-string">jdbc</span>
<span class="hljs-meta">spring.quartz.scheduler-name</span>=<span class="hljs-string">communityScheduler</span>
<span class="hljs-meta">spring.quartz.properties.org.quartz.scheduler.instanceId</span>=<span class="hljs-string">AUTO</span>
<span class="hljs-meta">spring.quartz.properties.org.quartz.jobStore.class</span>=<span class="hljs-string">org.quartz.impl.jdbcjobstore.JobStoreTX</span>
<span class="hljs-meta">spring.quartz.properties.org.quartz.jobStore.driverDelegateClass</span>=<span class="hljs-string">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span>
<span class="hljs-meta">spring.quartz.properties.org.quartz.jobStore.isClustered</span>=<span class="hljs-string">true</span>
<span class="hljs-meta">spring.quartz.properties.org.quartz.threadPool.class</span>=<span class="hljs-string">org.quartz.simpl.SimpleThreadPool</span>
<span class="hljs-meta">spring.quartz.properties.org.quartz.threadPool.threadCount</span>=<span class="hljs-string">5</span></code></pre></div>



</li>
</ol>
<h3 id="热帖开发流程"><a href="#热帖开发流程" class="headerlink" title="热帖开发流程"></a>热帖开发流程</h3><ol>
<li><p>编写rediskey</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREFIX_POST = <span class="hljs-string">&quot;post&quot;</span>;
 <span class="hljs-comment">//帖子分数(点赞加精等操作 存入postId)</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getPostScoreKey</span><span class="hljs-params">()</span></span>&#123;
     <span class="hljs-keyword">return</span> PREFIX_POST + SPILIT + <span class="hljs-string">&quot;score&quot;</span>;
 &#125;</code></pre></div>
</li>
<li><p>编写DiscusspotsController</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223163417.png" srcset="/img/loading.gif" alt="1"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223163438.png" srcset="/img/loading.gif" alt="2"></p>
</li>
</ol>
<ol start="3">
<li><p>编写likeController</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223163525.png" srcset="/img/loading.gif" alt="like"></p>
</li>
<li><p>编写CommentController</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223163613.png" srcset="/img/loading.gif" alt="comment"></p>
</li>
<li><p>编写job（任务）</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostScoreRefreshJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Job</span>, <span class="hljs-title">CommunityConstant</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(PostScoreRefreshJob.class);

    <span class="hljs-comment">// 牛客纪元</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Date epoch;

    <span class="hljs-keyword">static</span> &#123;
        <span class="hljs-keyword">try</span> &#123;
            epoch = <span class="hljs-keyword">new</span> SimpleDateFormat(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).parse(<span class="hljs-string">&quot;2014-08-01 00:00:00&quot;</span>);
        &#125; <span class="hljs-keyword">catch</span> (ParseException e) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;初始化牛客纪元失败!&quot;</span>, e);
        &#125;
    &#125;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscussPostService discussPostService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LikeService likeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticSearchService elasticSearchService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(JobExecutionContext context)</span> <span class="hljs-keyword">throws</span> JobExecutionException </span>&#123;
        String redisKey = RedisKeyUtil.getPostScoreKey();
        BoundSetOperations operations = redisTemplate.boundSetOps(redisKey);

        <span class="hljs-keyword">if</span> (operations.size() == <span class="hljs-number">0</span>) &#123;
            logger.info(<span class="hljs-string">&quot;[任务取消] 没有需要刷新的帖子!&quot;</span>);
            <span class="hljs-keyword">return</span>;
        &#125;

        logger.info(<span class="hljs-string">&quot;[任务开始] 正在刷新帖子分数: &quot;</span> + operations.size());
        <span class="hljs-keyword">while</span> (operations.size() &gt; <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">this</span>.refresh((Integer) operations.pop());
        &#125;
        logger.info(<span class="hljs-string">&quot;[任务结束] 帖子分数刷新完毕!&quot;</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">(<span class="hljs-keyword">int</span> postId)</span> </span>&#123;
        DiscussPost post = discussPostService.findDiscussPostById(postId);

        <span class="hljs-keyword">if</span> (post == <span class="hljs-keyword">null</span>) &#123;
            logger.error(<span class="hljs-string">&quot;该帖子不存在: id = &quot;</span> + postId);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">// 是否精华</span>
        <span class="hljs-keyword">boolean</span> wonderful = post.getStatus() == <span class="hljs-number">1</span>;
        <span class="hljs-comment">// 评论数量</span>
        <span class="hljs-keyword">int</span> commentCount = post.getCommentCount();
        <span class="hljs-comment">// 点赞数量</span>
        <span class="hljs-keyword">long</span> likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId);

        <span class="hljs-comment">// 计算权重</span>
        <span class="hljs-keyword">double</span> w = (wonderful ? <span class="hljs-number">75</span> : <span class="hljs-number">0</span>) + commentCount * <span class="hljs-number">10</span> + likeCount * <span class="hljs-number">2</span>;
        <span class="hljs-comment">// 分数 = 帖子权重 + 距离天数</span>
        <span class="hljs-keyword">double</span> score = Math.log10(Math.max(w, <span class="hljs-number">1</span>))
                + (post.getCreateTime().getTime() - epoch.getTime()) / (<span class="hljs-number">1000</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">24</span>);
        <span class="hljs-comment">// 更新帖子分数</span>
        discussPostService.updateScore(postId, score);
        <span class="hljs-comment">// 同步搜索数据</span>
        post.setScore(score);
        elasticSearchService.saveDiscussPost(post);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>编写DiscusspostService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateScore</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, <span class="hljs-keyword">double</span> score)</span></span>&#123;
    <span class="hljs-keyword">return</span> discussPostMapper.updateScore(id, score);
&#125;</code></pre></div>
</li>
<li><p>编写QuartzConfig</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 配置 -&gt; 数据库 -&gt; 访问db调度任务</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QuartzConfig</span> </span>&#123;

    <span class="hljs-comment">// BeanFactory 是IOC容器顶层接口</span>
    <span class="hljs-comment">// FactoryBean 可简化Bean的实例化过程:</span>
    <span class="hljs-comment">// 1.Spring通过FactoryBean封装了Bean的实例化过程</span>
    <span class="hljs-comment">// 2.将FactoryBean装配到Spring容器中</span>
    <span class="hljs-comment">// 3.将FactoryBean注入给其他的Bean</span>
    <span class="hljs-comment">// 4.该Bean得到的是FactoryBean所管理的对象实例</span>

    <span class="hljs-comment">// 配置JobDetail</span>
    <span class="hljs-comment">//@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> JobDetailFactoryBean <span class="hljs-title">jobDetailTest</span><span class="hljs-params">()</span></span>&#123;
        JobDetailFactoryBean jobDetailFactoryBean = <span class="hljs-keyword">new</span>  JobDetailFactoryBean();
        jobDetailFactoryBean.setJobClass(JobTest.class);
        jobDetailFactoryBean.setName(<span class="hljs-string">&quot;JobTest&quot;</span>);
        jobDetailFactoryBean.setGroup(<span class="hljs-string">&quot;testJobGroup&quot;</span>);
        <span class="hljs-comment">// 声明任务持久保存</span>
        jobDetailFactoryBean.setDurability(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">// 任务是否可恢复</span>
        jobDetailFactoryBean.setRequestsRecovery(<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">return</span> jobDetailFactoryBean;
    &#125;

    <span class="hljs-comment">// trigger 触发器 与 JobDetail有关系</span>
    <span class="hljs-comment">// 配置Trigger(SimpleTriggerFactoryBean, CronTriggerFactoryBea(复杂,解决每个月月底何时xxx))</span>
    <span class="hljs-comment">//@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleTriggerFactoryBean <span class="hljs-title">triggerTest</span><span class="hljs-params">(JobDetail jobDetailTest)</span></span>&#123;
        SimpleTriggerFactoryBean factoryBean = <span class="hljs-keyword">new</span> SimpleTriggerFactoryBean();
        factoryBean.setJobDetail(jobDetailTest);
        factoryBean.setName(<span class="hljs-string">&quot;triggerTest&quot;</span>);
        factoryBean.setGroup(<span class="hljs-string">&quot;testTriggerGroup&quot;</span>);
        <span class="hljs-comment">// 执行频率</span>
        factoryBean.setRepeatInterval(<span class="hljs-number">3000</span>);
        <span class="hljs-comment">// trigger底层存储job状态</span>
        factoryBean.setJobDataMap(<span class="hljs-keyword">new</span> JobDataMap());
        <span class="hljs-keyword">return</span> factoryBean;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> JobDetailFactoryBean <span class="hljs-title">postScoreRefreshJobDetail</span><span class="hljs-params">()</span></span>&#123;
        JobDetailFactoryBean jobDetailFactoryBean = <span class="hljs-keyword">new</span>  JobDetailFactoryBean();
        jobDetailFactoryBean.setJobClass(PostScoreRefreshJob.class);
        jobDetailFactoryBean.setName(<span class="hljs-string">&quot;postScoreRefreshJob&quot;</span>);
        jobDetailFactoryBean.setGroup(<span class="hljs-string">&quot;communityJobGroup&quot;</span>);
        <span class="hljs-comment">// 声明任务持久保存</span>
        jobDetailFactoryBean.setDurability(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">// 任务是否可恢复</span>
        jobDetailFactoryBean.setRequestsRecovery(<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">return</span> jobDetailFactoryBean;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleTriggerFactoryBean <span class="hljs-title">postScoreRefreshTrigger</span><span class="hljs-params">(JobDetail postScoreRefreshJobDetail)</span></span>&#123;
        SimpleTriggerFactoryBean factoryBean = <span class="hljs-keyword">new</span> SimpleTriggerFactoryBean();
        factoryBean.setJobDetail(postScoreRefreshJobDetail);
        factoryBean.setName(<span class="hljs-string">&quot;postScoreRefreshTrigger&quot;</span>);
        factoryBean.setGroup(<span class="hljs-string">&quot;communityTriggerGroup&quot;</span>);
        <span class="hljs-comment">// 执行频率</span>
        factoryBean.setRepeatInterval(<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>);
        <span class="hljs-comment">// trigger底层存储job状态</span>
        factoryBean.setJobDataMap(<span class="hljs-keyword">new</span> JobDataMap());
        <span class="hljs-keyword">return</span> factoryBean;
    &#125;
&#125;</code></pre></div>



</li>
</ol>
<h3 id="开发流程图-12"><a href="#开发流程图-12" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223164912.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="头像上传七牛云"><a href="#头像上传七牛云" class="headerlink" title="头像上传七牛云"></a>头像上传七牛云</h2><h3 id="开发流程-19"><a href="#开发流程-19" class="headerlink" title="开发流程"></a>开发流程</h3><ol>
<li><p>Maven</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.qiniu/qiniu-java-sdk --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.qiniu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>qiniu-java-sdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.2.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>配置qini</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223165129.png" srcset="/img/loading.gif" alt="配置"></p>
<p>具体依赖自己的qiniu配置</p>
</li>
<li><p>修改UserController</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;qiniu.key.access&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String accessKey;
   
<span class="hljs-meta">@Value(&quot;$&#123;qiniu.key.secret&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String secretKey;
   
<span class="hljs-meta">@Value(&quot;$&#123;qiniu.bucket.header.name&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String headerBucketName;
   
<span class="hljs-meta">@Value(&quot;$&#123;qiniu.bucket.header.url&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String headerBucketUrl;
   
<span class="hljs-meta">@LoginRequired</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET)</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSettingPage</span><span class="hljs-params">(Model model)</span> </span>&#123;
    <span class="hljs-comment">// 生成上传文件名称</span>
    String fileName = CommunityUtil.generateUUID();
    <span class="hljs-comment">// 设置响应信息</span>
    StringMap policy = <span class="hljs-keyword">new</span> StringMap();
    policy.put(<span class="hljs-string">&quot;returnBody&quot;</span>, CommunityUtil.getJSONString(<span class="hljs-number">0</span>));
    <span class="hljs-comment">// 生成上传凭证</span>
    Auth auth = Auth.create(accessKey, secretKey);
    String uploadToken = auth.uploadToken(headerBucketName, fileName, <span class="hljs-number">3600</span>, policy);
   
    model.addAttribute(<span class="hljs-string">&quot;uploadToken&quot;</span>, uploadToken);
    model.addAttribute(<span class="hljs-string">&quot;fileName&quot;</span>, fileName);
   
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;site/setting&quot;</span>;
&#125;
   
<span class="hljs-comment">// 更新头像路径 异步</span>
<span class="hljs-meta">@RequestMapping(path = &quot;/header/url&quot;, method = RequestMethod.POST)</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">updateHeader</span><span class="hljs-params">(String fileName)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (StringUtils.isBlank(fileName)) &#123;
        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;文件名不能为空&quot;</span>);
    &#125;
   
    String url = headerBucketUrl + <span class="hljs-string">&quot;/&quot;</span> + fileName;
    userService.updateHeadUrl(hostHolder.getUsers().getId(), url);
   
    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>);
&#125;</code></pre></div>
</li>
<li><p>更新前端表单</p>
<div class="hljs"><pre><code class="hljs js">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    $(<span class="hljs-string">&quot;#uploadForm&quot;</span>).submit(upload);
&#125;);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"></span>) </span>&#123;
    $.ajax(&#123;
        url: <span class="hljs-string">&quot;http://upload-z2.qiniup.com&quot;</span>,
        method: <span class="hljs-string">&quot;post&quot;</span>,
        processData: <span class="hljs-literal">false</span>,
        contentType: <span class="hljs-literal">false</span>,
        data: <span class="hljs-keyword">new</span> FormData($(<span class="hljs-string">&quot;#uploadForm&quot;</span>)[<span class="hljs-number">0</span>]),
        success: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
            <span class="hljs-keyword">if</span>(data &amp;&amp; data.code == <span class="hljs-number">0</span>) &#123;
                <span class="hljs-comment">// 更新头像访问路径</span>
                $.post(
                    CONTEXT_PATH + <span class="hljs-string">&quot;/user/header/url&quot;</span>,
                    &#123;<span class="hljs-string">&quot;fileName&quot;</span>:$(<span class="hljs-string">&quot;input[name=&#x27;key&#x27;]&quot;</span>).val()&#125;,
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>&#123;
                        data = $.parseJSON(data);
                        <span class="hljs-keyword">if</span>(data.code == <span class="hljs-number">0</span>) &#123;
                            <span class="hljs-built_in">window</span>.location.reload();
                        &#125; <span class="hljs-keyword">else</span> &#123;
                            alert(data.msg);
                        &#125;
                    &#125;
                );
            &#125; <span class="hljs-keyword">else</span> &#123;
                alert(<span class="hljs-string">&quot;上传失败!&quot;</span>);
            &#125;
        &#125;
    &#125;);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
&#125;
</code></pre></div>
</li>
<li><p>更新表单</p>
<div class="hljs"><pre><code class="hljs java">&lt;form <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;mt-5&quot;</span> id=<span class="hljs-string">&quot;uploadForm&quot;</span>&gt;
   &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;form-group row mt-4&quot;</span>&gt;
      &lt;label for=&quot;head-image&quot; class=&quot;col-sm-2 col-form-label text-right&quot;&gt;选择头像:&lt;/label&gt;
      &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;col-sm-10&quot;</span>&gt;
         &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;custom-file&quot;</span>&gt;
            &lt;input type=<span class="hljs-string">&quot;hidden&quot;</span> name=<span class="hljs-string">&quot;token&quot;</span> th:value=<span class="hljs-string">&quot;$&#123;uploadToken&#125;&quot;</span>&gt;
            &lt;input type=<span class="hljs-string">&quot;hidden&quot;</span> name=<span class="hljs-string">&quot;key&quot;</span> th:value=<span class="hljs-string">&quot;$&#123;fileName&#125;&quot;</span>&gt;
            &lt;input type=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;custom-file-input&quot;</span> id=<span class="hljs-string">&quot;head-image&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> lang=<span class="hljs-string">&quot;es&quot;</span> required=<span class="hljs-string">&quot;&quot;</span>&gt;
            &lt;label class=&quot;custom-file-label&quot; for=&quot;head-image&quot; data-browse=&quot;文件&quot;&gt;选择一张图片&lt;/label&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;invalid-feedback&quot;</span>&gt;
               该账号不存在!
            &lt;/div&gt;
         &lt;/div&gt;
      &lt;/div&gt;
   &lt;/div&gt;
   &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;form-group row mt-4&quot;</span>&gt;
      &lt;div class=&quot;col-sm-2&quot;&gt;&lt;/div&gt;
      &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;col-sm-10 text-center&quot;</span>&gt;
         &lt;button type=&quot;submit&quot; class=&quot;btn btn-info text-white form-control&quot;&gt;立即上传&lt;/button&gt;
      &lt;/div&gt;
   &lt;/div&gt;
&lt;/form&gt;</code></pre></div>

</li>
</ol>
<h3 id="开发流程图-13"><a href="#开发流程图-13" class="headerlink" title="开发流程图"></a>开发流程图</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223170535.png" srcset="/img/loading.gif" alt="流程图"></p>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><ul>
<li>本地缓存<ul>
<li>将数据缓存在应用服务器上,性能最好。</li>
<li>常用缓存工具: Ehcache、 Guava、 Caffeine等。</li>
</ul>
</li>
<li>分布式缓存<ul>
<li>将数据缓存在NoSQL数据库上，跨服务器。常用缓存工具: MemCache、Redis等。</li>
</ul>
</li>
<li>多级缓存<ul>
<li>一级缓存(本地缓存)&gt;二级缓存(分布式缓存)&gt;DB</li>
</ul>
</li>
<li>避免缓存雪崩(缓存失效，大量请求直达DB )，提高系统的可用性。</li>
</ul>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223171345.png" srcset="/img/loading.gif" alt="redis共享缓存"></p>
<p>​       redis可以跨服务器</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223171726.png" srcset="/img/loading.gif" alt="redis单体"></p>
<h3 id="caffeine-作缓存开发流程"><a href="#caffeine-作缓存开发流程" class="headerlink" title="caffeine 作缓存开发流程"></a>caffeine 作缓存开发流程</h3><ol>
<li><p>Maven</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.github.ben-manes.caffeine/caffeine --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>
</li>
<li><p>配置caffeine</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment"># caffeine 缓存热帖</span>
<span class="hljs-meta">caffeine.posts.max-size</span>=<span class="hljs-string">15</span>
<span class="hljs-comment"># 三分钟</span>
<span class="hljs-meta">caffeine.posts.expire-seconds</span>=<span class="hljs-string">180</span></code></pre></div>
</li>
<li><p>编写DiscussPostService</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;caffeine.posts.max-size&#125;&quot;)</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxSize;
   
<span class="hljs-meta">@Value(&quot;$&#123;caffeine.posts.expire-seconds&#125;&quot;)</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> expireSeconds;
   
<span class="hljs-comment">// caffeine 核心接口: Cache, LoadingCache, AsyncLoadingCache</span>
   
<span class="hljs-comment">// 缓存帖子列表</span>
<span class="hljs-keyword">private</span> LoadingCache&lt;String, List&lt;DiscussPost&gt;&gt; postListCache;
   
<span class="hljs-comment">// 缓存帖子总数</span>
<span class="hljs-keyword">private</span> LoadingCache&lt;Integer, Integer&gt; postRowsCache;
   
<span class="hljs-meta">@PostConstruct</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-comment">// 初始化缓存</span>
    <span class="hljs-comment">// 帖子列表</span>
    postListCache = Caffeine.newBuilder()
            .maximumSize(maxSize)
            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)
            .build(<span class="hljs-keyword">new</span> CacheLoader&lt;String, List&lt;DiscussPost&gt;&gt;() &#123;
                <span class="hljs-meta">@Nullable</span>
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;DiscussPost&gt; <span class="hljs-title">load</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String key)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
                    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span> || key.length() == <span class="hljs-number">0</span>)&#123;
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数错误&quot;</span>);
                    &#125;
   
                    String[] params = key.split(<span class="hljs-string">&quot;:&quot;</span>);
                    <span class="hljs-keyword">if</span> (params == <span class="hljs-keyword">null</span> || params.length!=<span class="hljs-number">2</span>)&#123;
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;参数错误&quot;</span>);
                    &#125;
                    <span class="hljs-keyword">int</span> offset = Integer.valueOf(params[<span class="hljs-number">0</span>]);
                    <span class="hljs-keyword">int</span> limit = Integer.valueOf(params[<span class="hljs-number">1</span>]);
                    <span class="hljs-comment">// 可以加入二级缓存:Redis -&gt; mysql</span>
                    logger.debug(<span class="hljs-string">&quot;load post list from DB.&quot;</span>);
                    <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPosts(<span class="hljs-number">0</span>, offset, limit, <span class="hljs-number">1</span>);
                &#125;
            &#125;);
    <span class="hljs-comment">// 帖子总数</span>
    postRowsCache = Caffeine.newBuilder()
            .maximumSize(maxSize)
            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)
            .build(<span class="hljs-keyword">new</span> CacheLoader&lt;Integer, Integer&gt;() &#123;
                <span class="hljs-meta">@Nullable</span>
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">load</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Integer integer)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
                    logger.debug(<span class="hljs-string">&quot;load post rows from DB.&quot;</span>);
                    <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPostRows(integer);
                &#125;
            &#125;);
&#125;</code></pre></div>
</li>
<li><p>对find方法修改</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223172210.png" srcset="/img/loading.gif" alt="修改"></p>
</li>
</ol>
<h3 id="caffeine缓存性能测试"><a href="#caffeine缓存性能测试" class="headerlink" title="caffeine缓存性能测试"></a>caffeine缓存性能测试</h3><p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223173220.png" srcset="/img/loading.gif" alt="添加缓存"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223173259.png" srcset="/img/loading.gif" alt="添加缓存"></p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223173344.png" srcset="/img/loading.gif" alt="优化去除后"></p>
<p>再次测试</p>
<p><img src="https://blogimgurl.oss-cn-hangzhou.aliyuncs.com/img20201223173436.png" srcset="/img/loading.gif" alt="吞吐量变化"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/12/25/%E5%89%91%E6%8C%87offer/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">剑指offer</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/02/JVM%E8%A7%A3%E5%AF%86/">
                        <span class="hidden-mobile">JVM解密</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>





  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



<!-- hexo injector body_end start -->
  <script src="/js/custom.js"></script>
<!-- hexo injector body_end end --></body>
</html>
